<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JUC线程池: Fork/Join框架详解 | Lowsky&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/vblog/Eminem.svg">
    <meta name="description" content="">
    
    <link rel="preload" href="/vblog/assets/css/0.styles.0a50441d.css" as="style"><link rel="preload" href="/vblog/assets/js/app.83d9a4e3.js" as="script"><link rel="preload" href="/vblog/assets/js/3.777b06c3.js" as="script"><link rel="preload" href="/vblog/assets/js/1.0fcecb2e.js" as="script"><link rel="preload" href="/vblog/assets/js/61.336f0c64.js" as="script"><link rel="prefetch" href="/vblog/assets/js/10.eddf0971.js"><link rel="prefetch" href="/vblog/assets/js/11.53cf0fdd.js"><link rel="prefetch" href="/vblog/assets/js/12.46ee9720.js"><link rel="prefetch" href="/vblog/assets/js/13.9593de85.js"><link rel="prefetch" href="/vblog/assets/js/14.d3199e68.js"><link rel="prefetch" href="/vblog/assets/js/15.1b25f5fb.js"><link rel="prefetch" href="/vblog/assets/js/16.f46e00d6.js"><link rel="prefetch" href="/vblog/assets/js/17.f5d2ce60.js"><link rel="prefetch" href="/vblog/assets/js/18.a8ccc0e1.js"><link rel="prefetch" href="/vblog/assets/js/19.b55f5052.js"><link rel="prefetch" href="/vblog/assets/js/20.0ebe7d77.js"><link rel="prefetch" href="/vblog/assets/js/21.e129490d.js"><link rel="prefetch" href="/vblog/assets/js/22.78c54d7a.js"><link rel="prefetch" href="/vblog/assets/js/23.922ef3d5.js"><link rel="prefetch" href="/vblog/assets/js/24.a83edf81.js"><link rel="prefetch" href="/vblog/assets/js/25.f12bfce5.js"><link rel="prefetch" href="/vblog/assets/js/26.c2ec5b3e.js"><link rel="prefetch" href="/vblog/assets/js/27.6ee9e8ec.js"><link rel="prefetch" href="/vblog/assets/js/28.2cb4c661.js"><link rel="prefetch" href="/vblog/assets/js/29.ca624be2.js"><link rel="prefetch" href="/vblog/assets/js/30.0c9707e0.js"><link rel="prefetch" href="/vblog/assets/js/31.c1bc5b6a.js"><link rel="prefetch" href="/vblog/assets/js/32.c89eb39c.js"><link rel="prefetch" href="/vblog/assets/js/33.b5cb88b2.js"><link rel="prefetch" href="/vblog/assets/js/34.18449792.js"><link rel="prefetch" href="/vblog/assets/js/35.18256367.js"><link rel="prefetch" href="/vblog/assets/js/36.a88cc574.js"><link rel="prefetch" href="/vblog/assets/js/37.27a322fb.js"><link rel="prefetch" href="/vblog/assets/js/38.66b5bedb.js"><link rel="prefetch" href="/vblog/assets/js/39.2b244087.js"><link rel="prefetch" href="/vblog/assets/js/4.4ed18b14.js"><link rel="prefetch" href="/vblog/assets/js/40.4b89b601.js"><link rel="prefetch" href="/vblog/assets/js/41.f519bf7e.js"><link rel="prefetch" href="/vblog/assets/js/42.2378a105.js"><link rel="prefetch" href="/vblog/assets/js/43.0c994a8e.js"><link rel="prefetch" href="/vblog/assets/js/44.61e6bb5b.js"><link rel="prefetch" href="/vblog/assets/js/45.d527f1ad.js"><link rel="prefetch" href="/vblog/assets/js/46.a1c125f1.js"><link rel="prefetch" href="/vblog/assets/js/47.51b2165c.js"><link rel="prefetch" href="/vblog/assets/js/48.7ecfa466.js"><link rel="prefetch" href="/vblog/assets/js/49.bfa3e005.js"><link rel="prefetch" href="/vblog/assets/js/5.5455eb2a.js"><link rel="prefetch" href="/vblog/assets/js/50.50ce004d.js"><link rel="prefetch" href="/vblog/assets/js/51.225a8c81.js"><link rel="prefetch" href="/vblog/assets/js/52.ddf3e67a.js"><link rel="prefetch" href="/vblog/assets/js/53.d3c29ce6.js"><link rel="prefetch" href="/vblog/assets/js/54.2c85d71b.js"><link rel="prefetch" href="/vblog/assets/js/55.fd047131.js"><link rel="prefetch" href="/vblog/assets/js/56.792ea18a.js"><link rel="prefetch" href="/vblog/assets/js/57.b9d67948.js"><link rel="prefetch" href="/vblog/assets/js/58.d4c71992.js"><link rel="prefetch" href="/vblog/assets/js/59.9a017676.js"><link rel="prefetch" href="/vblog/assets/js/6.4eb6a8e7.js"><link rel="prefetch" href="/vblog/assets/js/60.8b4101b1.js"><link rel="prefetch" href="/vblog/assets/js/62.2ac9b817.js"><link rel="prefetch" href="/vblog/assets/js/63.7d078ce5.js"><link rel="prefetch" href="/vblog/assets/js/64.7ae5530d.js"><link rel="prefetch" href="/vblog/assets/js/65.58d38999.js"><link rel="prefetch" href="/vblog/assets/js/66.ceacb78f.js"><link rel="prefetch" href="/vblog/assets/js/67.82b13977.js"><link rel="prefetch" href="/vblog/assets/js/68.81cc4de5.js"><link rel="prefetch" href="/vblog/assets/js/69.7ffe031a.js"><link rel="prefetch" href="/vblog/assets/js/7.9f41483b.js"><link rel="prefetch" href="/vblog/assets/js/70.bb26df08.js"><link rel="prefetch" href="/vblog/assets/js/71.40b8a64f.js"><link rel="prefetch" href="/vblog/assets/js/72.575fd9f1.js"><link rel="prefetch" href="/vblog/assets/js/73.e9694c3a.js"><link rel="prefetch" href="/vblog/assets/js/74.42892068.js"><link rel="prefetch" href="/vblog/assets/js/75.9485af20.js"><link rel="prefetch" href="/vblog/assets/js/76.d0dc58ff.js"><link rel="prefetch" href="/vblog/assets/js/77.4d4bfd81.js"><link rel="prefetch" href="/vblog/assets/js/78.63de0bab.js"><link rel="prefetch" href="/vblog/assets/js/79.4301edd3.js"><link rel="prefetch" href="/vblog/assets/js/8.d1f993ce.js"><link rel="prefetch" href="/vblog/assets/js/80.11609cde.js"><link rel="prefetch" href="/vblog/assets/js/81.a3f98ee1.js"><link rel="prefetch" href="/vblog/assets/js/82.f69ccb1d.js"><link rel="prefetch" href="/vblog/assets/js/83.3666b117.js"><link rel="prefetch" href="/vblog/assets/js/84.7416ca68.js"><link rel="prefetch" href="/vblog/assets/js/9.819f7973.js">
    <link rel="stylesheet" href="/vblog/assets/css/0.styles.0a50441d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-58d791b2><div data-v-58d791b2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-08f61db9 data-v-58d791b2 data-v-58d791b2><h3 class="title" data-v-08f61db9>Lowsky's blog</h3> <p class="description" data-v-08f61db9></p> <label id="box" class="inputBox" data-v-08f61db9><input type="password" value="" data-v-08f61db9> <span data-v-08f61db9>Konck! Knock!</span> <button data-v-08f61db9>OK</button></label> <div class="footer" data-v-08f61db9><span data-v-08f61db9><i class="iconfont reco-theme" data-v-08f61db9></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-08f61db9>vuePress-theme-reco</a></span> <span data-v-08f61db9><i class="iconfont reco-copyright" data-v-08f61db9></i> <a data-v-08f61db9><!---->
          
        <!---->
        2023
      </a></span></div></div> <div class="hide" data-v-58d791b2><header class="navbar" data-v-58d791b2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vblog/" class="home-link router-link-active"><img src="/vblog/Eminem.svg" alt="Lowsky's blog" class="logo"> <span class="site-name">Lowsky's blog</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vblog/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      Java
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vblog/java/basic/java-basic-oop.html" class="nav-link"><i class="undefined"></i>
  Java 基础
</a></li><li class="dropdown-item"><!----> <a href="/vblog/java/collection/java-collection-all.html" class="nav-link"><i class="undefined"></i>
  Java 集合框架
</a></li><li class="dropdown-item"><!----> <a href="/vblog/java/thread/java-thread-x-overview.html" class="nav-link"><i class="undefined"></i>
  Java 多线程与并发
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      算法
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vblog/algorithm/basic/alg-basic-overview.html" class="nav-link"><i class="undefined"></i>
  算法基础思想
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      数据库
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vblog/sql/basic/sql-db.html" class="nav-link"><i class="undefined"></i>
  数据库基础和原理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      Spring
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vblog/spring/basic/spring.html" class="nav-link"><i class="undefined"></i>
  Spring Framework 5基础
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      开发必备
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://www.fly63.com/tool/ascii/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  在线ASCII码表
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://regexr.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  正则表达式调试工具
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      技术文档
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://git-scm.com/book/zh/v2" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Git中文教程
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.nginx.cn/doc/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Nginx中文文档
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://kafka.apachecn.org/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Kafka中文文档
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <a href="https://github.com/lowskylee/vblog" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask" data-v-58d791b2></div> <aside class="sidebar" data-v-58d791b2><div class="personal-info-wrapper" data-v-3d87d2e4 data-v-58d791b2><!----> <!----> <div class="num" data-v-3d87d2e4><div data-v-3d87d2e4><h3 data-v-3d87d2e4>73</h3> <h6 data-v-3d87d2e4>文章</h6></div> <div data-v-3d87d2e4><h3 data-v-3d87d2e4>0</h3> <h6 data-v-3d87d2e4>标签</h6></div></div> <ul class="social-links" data-v-3d87d2e4></ul> <hr data-v-3d87d2e4></div> <nav class="nav-links"><div class="nav-item"><a href="/vblog/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      Java
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vblog/java/basic/java-basic-oop.html" class="nav-link"><i class="undefined"></i>
  Java 基础
</a></li><li class="dropdown-item"><!----> <a href="/vblog/java/collection/java-collection-all.html" class="nav-link"><i class="undefined"></i>
  Java 集合框架
</a></li><li class="dropdown-item"><!----> <a href="/vblog/java/thread/java-thread-x-overview.html" class="nav-link"><i class="undefined"></i>
  Java 多线程与并发
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      算法
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vblog/algorithm/basic/alg-basic-overview.html" class="nav-link"><i class="undefined"></i>
  算法基础思想
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      数据库
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vblog/sql/basic/sql-db.html" class="nav-link"><i class="undefined"></i>
  数据库基础和原理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      Spring
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vblog/spring/basic/spring.html" class="nav-link"><i class="undefined"></i>
  Spring Framework 5基础
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      开发必备
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://www.fly63.com/tool/ascii/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  在线ASCII码表
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://regexr.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  正则表达式调试工具
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      技术文档
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://git-scm.com/book/zh/v2" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Git中文教程
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.nginx.cn/doc/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Nginx中文文档
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://kafka.apachecn.org/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Kafka中文文档
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <a href="https://github.com/lowskylee/vblog" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java 基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java 集合框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java 多线程与并发</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vblog/java/thread/java-thread-x-overview.html" class="sidebar-link">Java并发知识体系详解</a></li><li><a href="/vblog/java/thread/java-thread-x-theorty.html" class="sidebar-link">Java 并发 - 理论基础</a></li><li><a href="/vblog/java/thread/java-thread-x-thread-basic.html" class="sidebar-link">Java 并发 - 线程基础</a></li><li><a href="/vblog/java/thread/java-thread-x-lock-all.html" class="sidebar-link">Java并发 - Java中所有的锁</a></li><li><a href="/vblog/java/thread/java-thread-x-key-synchronized.html" class="sidebar-link">关键字: synchronized详解</a></li><li><a href="/vblog/java/thread/java-thread-x-key-volatile.html" class="sidebar-link">关键字: volatile详解</a></li><li><a href="/vblog/java/thread/java-thread-x-key-final.html" class="sidebar-link">关键字: final详解</a></li><li><a href="/vblog/java/thread/java-thread-x-juc-overview.html" class="sidebar-link">JUC - 类汇总和学习指南</a></li><li><a href="/vblog/java/thread/java-thread-x-juc-AtomicInteger.html" class="sidebar-link">JUC原子类: CAS, Unsafe和原子类详解</a></li><li><a href="/vblog/java/thread/java-thread-x-lock-LockSupport.html" class="sidebar-link">JUC锁: LockSupport详解</a></li><li><a href="/vblog/java/thread/java-thread-x-lock-AbstractQueuedSynchronizer.html" class="sidebar-link">JUC锁: 锁核心类AQS详解</a></li><li><a href="/vblog/java/thread/java-thread-x-lock-ReentrantLock.html" class="sidebar-link">JUC锁: ReentrantLock详解</a></li><li><a href="/vblog/java/thread/java-thread-x-lock-ReentrantReadWriteLock.html" class="sidebar-link">JUC锁: ReentrantReadWriteLock详解</a></li><li><a href="/vblog/java/thread/java-thread-x-juc-collection-ConcurrentHashMap.html" class="sidebar-link">JUC集合: ConcurrentHashMap详解</a></li><li><a href="/vblog/java/thread/java-thread-x-juc-collection-CopyOnWriteArrayList.html" class="sidebar-link">JUC集合: CopyOnWriteArrayList详解</a></li><li><a href="/vblog/java/thread/java-thread-x-juc-collection-ConcurrentLinkedQueue.html" class="sidebar-link">JUC集合: ConcurrentLinkedQueue详解</a></li><li><a href="/vblog/java/thread/java-thread-x-juc-collection-BlockingQueue.html" class="sidebar-link">JUC集合: BlockingQueue详解</a></li><li><a href="/vblog/java/thread/java-thread-x-juc-executor-FutureTask.html" class="sidebar-link">JUC线程池: FutureTask详解</a></li><li><a href="/vblog/java/thread/java-thread-x-juc-executor-ThreadPoolExecutor.html" class="sidebar-link">JUC线程池: ThreadPoolExecutor详解</a></li><li><a href="/vblog/java/thread/java-thread-x-juc-executor-ScheduledThreadPoolExecutor.html" class="sidebar-link">JUC线程池: ScheduledThreadPoolExecutor详解</a></li><li><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html" aria-current="page" class="active sidebar-link">JUC线程池: Fork/Join框架详解</a></li><li><a href="/vblog/java/thread/java-thread-x-juc-tool-countdownlatch.html" class="sidebar-link">JUC工具类: CountDownLatch详解</a></li><li><a href="/vblog/java/thread/java-thread-x-juc-tool-cyclicbarrier.html" class="sidebar-link">JUC工具类: CyclicBarrier详解</a></li><li><a href="/vblog/java/thread/java-thread-x-juc-tool-semaphore.html" class="sidebar-link">JUC工具类: Semaphore详解</a></li><li><a href="/vblog/java/thread/java-thread-x-juc-tool-phaser.html" class="sidebar-link">JUC工具类: Phaser详解</a></li><li><a href="/vblog/java/thread/java-thread-x-juc-tool-exchanger.html" class="sidebar-link">JUC工具类: Exchanger详解</a></li><li><a href="/vblog/java/thread/java-thread-x-threadlocal.html" class="sidebar-link">Java 并发 - ThreadLocal详解</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-08f61db9 data-v-58d791b2><h3 class="title" data-v-08f61db9></h3> <!----> <label id="box" class="inputBox" data-v-08f61db9><input type="password" value="" data-v-08f61db9> <span data-v-08f61db9>Konck! Knock!</span> <button data-v-08f61db9>OK</button></label> <div class="footer" data-v-08f61db9><span data-v-08f61db9><i class="iconfont reco-theme" data-v-08f61db9></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-08f61db9>vuePress-theme-reco</a></span> <span data-v-08f61db9><i class="iconfont reco-copyright" data-v-08f61db9></i> <a data-v-08f61db9><!---->
          
        <!---->
        2023
      </a></span></div></div> <div data-v-58d791b2><div data-v-58d791b2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">JUC线程池: Fork/Join框架详解</h1> <div data-v-162cc157><!----> <!----> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h2 id="juc线程池-fork-join框架详解"><a href="#juc线程池-fork-join框架详解" class="header-anchor">#</a> JUC线程池: Fork/Join框架详解</h2> <blockquote><p>ForkJoinPool 是JDK 7加入的一个线程池类。Fork/Join 技术是分治算法(Divide-and-Conquer)的并行实现，它是一项可以获得良好的并行性能的简单且高效的设计技术。目的是为了帮助我们更好地利用多处理器带来的好处，使用所有可用的运算能力来提升应用的性能。</p></blockquote> <ul><li><a href="#juc%E7%BA%BF%E7%A8%8B%E6%B1%A0-forkjoin%E6%A1%86%E6%9E%B6%E8%AF%A6%E8%A7%A3">JUC线程池: Fork/Join框架详解</a> <ul><li><a href="#%E5%B8%A6%E7%9D%80bat%E5%A4%A7%E5%8E%82%E7%9A%84%E9%9D%A2%E8%AF%95%E9%97%AE%E9%A2%98%E5%8E%BB%E7%90%86%E8%A7%A3forkjoin%E6%A1%86%E6%9E%B6">带着BAT大厂的面试问题去理解Fork/Join框架</a></li> <li><a href="#forkjoin%E6%A1%86%E6%9E%B6%E7%AE%80%E4%BB%8B">Fork/Join框架简介</a> <ul><li><a href="#%E4%B8%89%E4%B8%AA%E6%A8%A1%E5%9D%97%E5%8F%8A%E5%85%B3%E7%B3%BB">三个模块及关系</a></li> <li><a href="#%E6%A0%B8%E5%BF%83%E6%80%9D%E6%83%B3-%E5%88%86%E6%B2%BB%E7%AE%97%E6%B3%95divide-and-conquer">核心思想: 分治算法(Divide-and-Conquer)</a></li> <li><a href="#%E6%A0%B8%E5%BF%83%E6%80%9D%E6%83%B3-work-stealing%E5%B7%A5%E4%BD%9C%E7%AA%83%E5%8F%96%E7%AE%97%E6%B3%95">核心思想: work-stealing(工作窃取)算法</a></li> <li><a href="#forkjoin-%E6%A1%86%E6%9E%B6%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B">Fork/Join 框架的执行流程</a></li></ul></li> <li><a href="#forkjoin%E7%B1%BB%E5%85%B3%E7%B3%BB">Fork/Join类关系</a> <ul><li><a href="#forkjoinpool%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB">ForkJoinPool继承关系</a></li> <li><a href="#forkjointask%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB">ForkJoinTask继承关系</a></li></ul></li> <li><a href="#forkjoin%E6%A1%86%E6%9E%B6%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90">Fork/Join框架源码解析</a> <ul><li><a href="#forkjoinpool">ForkJoinPool</a> <ul><li><a href="#%E6%A0%B8%E5%BF%83%E5%8F%82%E6%95%B0">核心参数</a></li> <li><a href="#forkjoinpoolworkqueue-%E4%B8%AD%E7%9A%84%E7%9B%B8%E5%85%B3%E5%B1%9E%E6%80%A7">ForkJoinPool.WorkQueue 中的相关属性:</a></li></ul></li> <li><a href="#forkjointask">ForkJoinTask</a> <ul><li><a href="#%E6%A0%B8%E5%BF%83%E5%8F%82%E6%95%B0-1">核心参数</a></li></ul></li></ul></li> <li><a href="#forkjoin%E6%A1%86%E6%9E%B6%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-1">Fork/Join框架源码解析</a> <ul><li><a href="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0">构造函数</a></li> <li><a href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B---%E5%A4%96%E9%83%A8%E4%BB%BB%E5%8A%A1externalsubmissions-task%E6%8F%90%E4%BA%A4">执行流程 - 外部任务(external/submissions task)提交</a> <ul><li><a href="#externalpushforkjointask-task">externalPush(ForkJoinTask&lt;?&gt; task)</a></li> <li><a href="#externalsubmitforkjointask-task">externalSubmit(ForkJoinTask&lt;?&gt; task)</a></li> <li><a href="#signalworkworkqueue-ws-workqueue-q">signalWork(WorkQueue[] ws, WorkQueue q)</a></li> <li><a href="#tryaddworkerlong-c">tryAddWorker(long c)</a></li> <li><a href="#createworker">createWorker()</a></li> <li><a href="#registerworker">registerWorker()</a></li> <li><a href="#%E5%B0%8F%E7%BB%93">小结</a></li></ul></li> <li><a href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B-%E5%AD%90%E4%BB%BB%E5%8A%A1worker-task%E6%8F%90%E4%BA%A4">执行流程: 子任务(Worker task)提交</a> <ul><li><a href="#forkjointaskfork">ForkJoinTask.fork()</a></li> <li><a href="#forkjoinpoolworkqueuepush">ForkJoinPool.WorkQueue.push()</a></li> <li><a href="#%E5%B0%8F%E7%BB%93-1">小结</a></li></ul></li> <li><a href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B-%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C">执行流程: 任务执行</a> <ul><li><a href="#forkjoinworkerthreadrun">ForkJoinWorkerThread.run()</a></li> <li><a href="#forkjoinpoolrunworkerworkqueue-w">ForkJoinPool.runWorker(WorkQueue w)</a></li> <li><a href="#forkjoinpoolscanworkqueue-w-int-r">ForkJoinPool.scan(WorkQueue w, int r)</a></li> <li><a href="#forkjoinpoolawaitworkworkqueue-w-int-r">ForkJoinPool.awaitWork(WorkQueue w, int r)</a></li> <li><a href="#workqueueruntask">WorkQueue.runTask()</a></li> <li><a href="#forkjoinpoolderegisterworkerforkjoinworkerthread-wt-throwable-ex">ForkJoinPool.deregisterWorker(ForkJoinWorkerThread wt, Throwable ex)</a></li> <li><a href="#%E5%B0%8F%E7%BB%93-2">小结</a></li></ul></li> <li><a href="#%E8%8E%B7%E5%8F%96%E4%BB%BB%E5%8A%A1%E7%BB%93%E6%9E%9C---forkjointaskjoin--forkjointaskinvoke">获取任务结果 - ForkJoinTask.join() / ForkJoinTask.invoke()</a> <ul><li><a href="#forkjointaskexternalawaitdone">ForkJoinTask.externalAwaitDone()</a></li> <li><a href="#forkjoinpoolawaitjoin">ForkJoinPool.awaitJoin()</a></li> <li><a href="#workqueuetryremoveandexecforkjointask-task">WorkQueue.tryRemoveAndExec(ForkJoinTask&lt;?&gt; task)</a></li> <li><a href="#forkjoinpoolhelpstealerworkqueue-w-forkjointask-task">ForkJoinPool.helpStealer(WorkQueue w, ForkJoinTask&lt;?&gt; task)</a></li> <li><a href="#forkjoinpooltrycompensateworkqueue-w">ForkJoinPool.tryCompensate(WorkQueue w)</a></li></ul></li></ul></li> <li><a href="#forkjoin%E7%9A%84%E9%99%B7%E9%98%B1%E4%B8%8E%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">Fork/Join的陷阱与注意事项</a> <ul><li><a href="#%E9%81%BF%E5%85%8D%E4%B8%8D%E5%BF%85%E8%A6%81%E7%9A%84fork">避免不必要的fork()</a></li> <li><a href="#%E6%B3%A8%E6%84%8Fforkcomputejoin%E7%9A%84%E9%A1%BA%E5%BA%8F">注意fork()、compute()、join()的顺序</a></li> <li><a href="#%E9%80%89%E6%8B%A9%E5%90%88%E9%80%82%E7%9A%84%E5%AD%90%E4%BB%BB%E5%8A%A1%E7%B2%92%E5%BA%A6">选择合适的子任务粒度</a></li> <li><a href="#%E9%81%BF%E5%85%8D%E9%87%8D%E9%87%8F%E7%BA%A7%E4%BB%BB%E5%8A%A1%E5%88%92%E5%88%86%E4%B8%8E%E7%BB%93%E6%9E%9C%E5%90%88%E5%B9%B6">避免重量级任务划分与结果合并</a></li></ul></li> <li><a href="#%E5%86%8D%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3">再深入理解</a> <ul><li><a href="#%E6%9C%89%E5%93%AA%E4%BA%9Bjdk%E6%BA%90%E7%A0%81%E4%B8%AD%E4%BD%BF%E7%94%A8%E4%BA%86forkjoin%E6%80%9D%E6%83%B3">有哪些JDK源码中使用了Fork/Join思想?</a></li> <li><a href="#%E4%BD%BF%E7%94%A8executors%E5%B7%A5%E5%85%B7%E7%B1%BB%E5%88%9B%E5%BB%BAforkjoinpool">使用Executors工具类创建ForkJoinPool</a></li> <li><a href="#%E5%85%B3%E4%BA%8Eforkjoin%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86">关于Fork/Join异常处理</a></li></ul></li> <li><a href="#%E4%B8%80%E4%BA%9Bforkjoin%E4%BE%8B%E5%AD%90">一些Fork/Join例子</a> <ul><li><a href="#%E9%87%87%E7%94%A8forkjoin%E6%9D%A5%E5%BC%82%E6%AD%A5%E8%AE%A1%E7%AE%9712310000%E7%9A%84%E7%BB%93%E6%9E%9C">采用Fork/Join来异步计算1+2+3+…+10000的结果</a></li> <li><a href="#%E5%AE%9E%E7%8E%B0%E6%96%90%E6%B3%A2%E9%82%A3%E5%A5%91%E6%95%B0%E5%88%97">实现斐波那契数列</a></li></ul></li> <li><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0">参考文章</a></li></ul></li></ul> <h2 id="带着bat大厂的面试问题去理解fork-join框架"><a href="#带着bat大厂的面试问题去理解fork-join框架" class="header-anchor">#</a> 带着BAT大厂的面试问题去理解Fork/Join框架</h2> <p>提示</p> <p>请带着这些问题继续后文，会很大程度上帮助你更好的理解Fork/Join框架。</p> <ul><li>Fork/Join主要用来解决什么样的问题?</li> <li>Fork/Join框架是在哪个JDK版本中引入的?</li> <li>Fork/Join框架主要包含哪三个模块? 模块之间的关系是怎么样的?</li> <li>ForkJoinPool类继承关系?</li> <li>ForkJoinTask抽象类继承关系? 在实际运用中，我们一般都会继承 RecursiveTask 、RecursiveAction 或 CountedCompleter 来实现我们的业务需求，而不会直接继承 ForkJoinTask 类。</li> <li>整个Fork/Join 框架的执行流程/运行机制是怎么样的?</li> <li>具体阐述Fork/Join的分治思想和work-stealing 实现方式?</li> <li>有哪些JDK源码中使用了Fork/Join思想?</li> <li>如何使用Executors工具类创建ForkJoinPool?</li> <li>写一个例子: 用ForkJoin方式实现1+2+3+...+100000?</li> <li>Fork/Join在使用时有哪些注意事项? 结合JDK中的斐波那契数列实例具体说明。</li></ul> <h2 id="fork-join框架简介"><a href="#fork-join框架简介" class="header-anchor">#</a> Fork/Join框架简介</h2> <p>Fork/Join框架是Java并发工具包中的一种可以将一个大任务拆分为很多小任务来异步执行的工具，自JDK1.7引入。</p> <h3 id="三个模块及关系"><a href="#三个模块及关系" class="header-anchor">#</a> 三个模块及关系</h3> <p>Fork/Join框架主要包含三个模块:</p> <ul><li>任务对象: <code>ForkJoinTask</code> (包括<code>RecursiveTask</code>、<code>RecursiveAction</code> 和 <code>CountedCompleter</code>)</li> <li>执行Fork/Join任务的线程: <code>ForkJoinWorkerThread</code></li> <li>线程池: <code>ForkJoinPool</code></li></ul> <p>这三者的关系是: ForkJoinPool可以通过池中的ForkJoinWorkerThread来处理ForkJoinTask任务。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// from 《A Java Fork/Join Framework》Dong Lea</span>
<span class="token class-name">Result</span> <span class="token function">solve</span><span class="token punctuation">(</span><span class="token class-name">Problem</span> problem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>problem is small<span class="token punctuation">)</span>
 		directly solve problem
 	<span class="token keyword">else</span> <span class="token punctuation">{</span>
 		split problem into independent parts
 		fork <span class="token keyword">new</span> subtasks <span class="token keyword">to</span> <span class="token namespace">solve</span> each part
 		join all subtasks
 		compose result from subresults
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ForkJoinPool 只接收 ForkJoinTask 任务(在实际使用中，也可以接收 Runnable/Callable 任务，但在真正运行时，也会把这些任务封装成 ForkJoinTask 类型的任务)，RecursiveTask 是 ForkJoinTask 的子类，是一个可以递归执行的 ForkJoinTask，RecursiveAction 是一个无返回值的 RecursiveTask，CountedCompleter 在任务完成执行后会触发执行一个自定义的钩子函数。</p> <p>在实际运用中，我们一般都会继承 <code>RecursiveTask</code> 、<code>RecursiveAction</code> 或 <code>CountedCompleter</code> 来实现我们的业务需求，而不会直接继承 ForkJoinTask 类。</p> <h3 id="核心思想-分治算法-divide-and-conquer"><a href="#核心思想-分治算法-divide-and-conquer" class="header-anchor">#</a> 核心思想: 分治算法(Divide-and-Conquer)</h3> <p>分治算法(Divide-and-Conquer)把任务递归的拆分为各个子任务，这样可以更好的利用系统资源，尽可能的使用所有可用的计算能力来提升应用性能。首先看一下 Fork/Join 框架的任务运行机制:</p> <p><img src="https://raw.githubusercontent.com/lowskylee/Pictures/main/images/java-thread-x-forkjoin-2.png" alt=""></p> <ul><li>这里也可以一并看下: <a href="https://www.pdai.tech/md/algorithm/alg-core-divide-and-conquer.html" target="_blank" rel="noopener noreferrer">算法思想 - 分治算法<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h3 id="核心思想-work-stealing-工作窃取-算法"><a href="#核心思想-work-stealing-工作窃取-算法" class="header-anchor">#</a> 核心思想: work-stealing(工作窃取)算法</h3> <p>work-stealing(工作窃取)算法: 线程池内的所有工作线程都尝试找到并执行已经提交的任务，或者是被其他活动任务创建的子任务(如果不存在就阻塞等待)。这种特性使得 ForkJoinPool 在运行多个可以产生子任务的任务，或者是提交的许多小任务时效率更高。尤其是构建异步模型的 ForkJoinPool 时，对不需要合并(join)的事件类型任务也非常适用。</p> <p>在 ForkJoinPool 中，线程池中每个工作线程(ForkJoinWorkerThread)都对应一个任务队列(WorkQueue)，工作线程优先处理来自自身队列的任务(LIFO或FIFO顺序，参数 mode 决定)，然后以FIFO的顺序随机窃取其他队列中的任务。</p> <p>具体思路如下:</p> <ul><li>每个线程都有自己的一个WorkQueue，该工作队列是一个双端队列。</li> <li>队列支持三个功能push、pop、poll</li> <li>push/pop只能被队列的所有者线程调用，而poll可以被其他线程调用。</li> <li>划分的子任务调用fork时，都会被push到自己的队列中。</li> <li>默认情况下，工作线程从自己的双端队列获出任务并执行。</li> <li>当自己的队列为空时，线程随机从另一个线程的队列末尾调用poll方法窃取任务。</li></ul> <p><img src="https://raw.githubusercontent.com/lowskylee/Pictures/main/images/java-thread-x-forkjoin-3.png" alt=""></p> <h3 id="fork-join-框架的执行流程"><a href="#fork-join-框架的执行流程" class="header-anchor">#</a> Fork/Join 框架的执行流程</h3> <p>上图可以看出ForkJoinPool 中的任务执行分两种:</p> <ul><li>直接通过 FJP 提交的外部任务(external/submissions task)，存放在 workQueues 的偶数槽位；</li> <li>通过内部 fork 分割的子任务(Worker task)，存放在 workQueues 的奇数槽位。</li></ul> <p>那Fork/Join 框架的执行流程是什么样的?</p> <p><img src="https://raw.githubusercontent.com/lowskylee/Pictures/main/images/java-thread-x-forkjoin-5.png" alt=""></p> <blockquote><p>后续的源码解析将围绕上图进行。</p></blockquote> <h2 id="fork-join类关系"><a href="#fork-join类关系" class="header-anchor">#</a> Fork/Join类关系</h2> <h3 id="forkjoinpool继承关系"><a href="#forkjoinpool继承关系" class="header-anchor">#</a> ForkJoinPool继承关系</h3> <p><img src="https://raw.githubusercontent.com/lowskylee/Pictures/main/images/java-thread-x-forkjoin-1.png" alt=""></p> <p>内部类介绍:</p> <ul><li><p>ForkJoinWorkerThreadFactory: 内部线程工厂接口，用于创建工作线程ForkJoinWorkerThread</p></li> <li><p>DefaultForkJoinWorkerThreadFactory: ForkJoinWorkerThreadFactory 的默认实现类</p></li> <li><p>InnocuousForkJoinWorkerThreadFactory: 实现了 ForkJoinWorkerThreadFactory，无许可线程工厂，当系统变量中有系统安全管理相关属性时，默认使用这个工厂创建工作线程。</p></li> <li><p>EmptyTask: 内部占位类，用于替换队列中 join 的任务。</p></li> <li><p>ManagedBlocker: 为 ForkJoinPool 中的任务提供扩展管理并行数的接口，一般用在可能会阻塞的任务(如在 Phaser 中用于等待 phase 到下一个generation)。</p></li> <li><p>WorkQueue: ForkJoinPool 的核心数据结构，本质上是work-stealing 模式的双端任务队列，内部存放 ForkJoinTask 对象任务，使用 @Contented 注解修饰防止伪共享。</p> <ul><li>工作线程在运行中产生新的任务(通常是因为调用了 fork())时，此时可以把 WorkQueue 的数据结构视为一个栈，新的任务会放入栈顶(top 位)；工作线程在处理自己工作队列的任务时，按照 LIFO 的顺序。</li> <li>工作线程在处理自己的工作队列同时，会尝试窃取一个任务(可能是来自于刚刚提交到 pool 的任务，或是来自于其他工作线程的队列任务)，此时可以把 WorkQueue 的数据结构视为一个 FIFO 的队列，窃取的任务位于其他线程的工作队列的队首(base位)。</li></ul></li> <li><p>伪共享状态: 缓存系统中是以缓存行(cache line)为单位存储的。缓存行是2的整数幂个连续字节，一般为32-256个字节。最常见的缓存行大小是64个字节。当多线程修改互相独立的变量时，如果这些变量共享同一个缓存行，就会无意中影响彼此的性能，这就是伪共享。</p></li></ul> <h3 id="forkjointask继承关系"><a href="#forkjointask继承关系" class="header-anchor">#</a> ForkJoinTask继承关系</h3> <p><img src="https://raw.githubusercontent.com/lowskylee/Pictures/main/images/java-thread-x-forkjoin-4.png" alt=""></p> <p>ForkJoinTask 实现了 Future 接口，说明它也是一个可取消的异步运算任务，实际上ForkJoinTask 是 Future 的轻量级实现，主要用在纯粹是计算的函数式任务或者操作完全独立的对象计算任务。fork 是主运行方法，用于异步执行；而 join 方法在任务结果计算完毕之后才会运行，用来合并或返回计算结果。 其内部类都比较简单，ExceptionNode 是用于存储任务执行期间的异常信息的单向链表；其余四个类是为 Runnable/Callable 任务提供的适配器类，用于把 Runnable/Callable 转化为 ForkJoinTask 类型的任务(因为 ForkJoinPool 只可以运行 ForkJoinTask 类型的任务)。</p> <h2 id="fork-join框架源码解析"><a href="#fork-join框架源码解析" class="header-anchor">#</a> Fork/Join框架源码解析</h2> <blockquote><p>分析思路: 在对类层次结构有了解以后，我们先看下内部核心参数，然后分析上述流程图。会分4个部分:</p></blockquote> <ul><li>首先介绍任务的提交流程 - 外部任务(external/submissions task)提交</li> <li>然后介绍任务的提交流程 - 子任务(Worker task)提交</li> <li>再分析任务的执行过程(ForkJoinWorkerThread.run()到ForkJoinTask.doExec()这一部分)；</li> <li>最后介绍任务的结果获取(ForkJoinTask.join()和ForkJoinTask.invoke())</li></ul> <h3 id="forkjoinpool"><a href="#forkjoinpool" class="header-anchor">#</a> ForkJoinPool</h3> <h4 id="核心参数"><a href="#核心参数" class="header-anchor">#</a> 核心参数</h4> <p>在后面的源码解析中，我们会看到大量的位运算，这些位运算都是通过我们接下来介绍的一些常量参数来计算的。</p> <p>例如，如果要更新活跃线程数，使用公式(UC_MASK &amp; (c + AC_UNIT)) | (SP_MASK &amp; c)；c 代表当前 ctl，UC_MASK 和 SP_MASK 分别是高位和低位掩码，AC_UNIT 为活跃线程的增量数，使用(UC_MASK &amp; (c + AC_UNIT))就可以计算出高32位，然后再加上低32位(SP_MASK &amp; c)，就拼接成了一个新的ctl。</p> <p>这些运算的可读性很差，看起来有些复杂。在后面源码解析中有位运算的地方我都会加上注释，大家只需要了解它们的作用即可。</p> <p>ForkJoinPool 与 内部类 WorkQueue 共享的一些常量:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Constants shared across ForkJoinPool and WorkQueue</span>

<span class="token comment">// 限定参数</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SMASK</span> <span class="token operator">=</span> <span class="token number">0xffff</span><span class="token punctuation">;</span>        <span class="token comment">//  低位掩码，也是最大索引位</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MAX_CAP</span> <span class="token operator">=</span> <span class="token number">0x7fff</span><span class="token punctuation">;</span>        <span class="token comment">//  工作线程最大容量</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">EVENMASK</span> <span class="token operator">=</span> <span class="token number">0xfffe</span><span class="token punctuation">;</span>        <span class="token comment">//  偶数低位掩码</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SQMASK</span> <span class="token operator">=</span> <span class="token number">0x007e</span><span class="token punctuation">;</span>        <span class="token comment">//  workQueues 数组最多64个槽位</span>

<span class="token comment">// ctl 子域和 WorkQueue.scanState 的掩码和标志位</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SCANNING</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>             <span class="token comment">// 标记是否正在运行任务</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">INACTIVE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">31</span><span class="token punctuation">;</span>       <span class="token comment">// 失活状态  负数</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SS_SEQ</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span>       <span class="token comment">// 版本戳，防止ABA问题</span>

<span class="token comment">// ForkJoinPool.config 和 WorkQueue.config 的配置信息标记</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MODE_MASK</span> <span class="token operator">=</span> <span class="token number">0xffff</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span>  <span class="token comment">// 模式掩码</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">LIFO_QUEUE</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//LIFO队列</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">FIFO_QUEUE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span><span class="token comment">//FIFO队列</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SHARED_QUEUE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">31</span><span class="token punctuation">;</span>       <span class="token comment">// 共享模式队列，负数</span>
</code></pre></div><p>ForkJoinPool 中的相关常量和实例字段:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//  低位和高位掩码</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">SP_MASK</span> <span class="token operator">=</span> <span class="token number">0</span>xffffffffL<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">UC_MASK</span> <span class="token operator">=</span> <span class="token operator">~</span><span class="token constant">SP_MASK</span><span class="token punctuation">;</span>

<span class="token comment">// 活跃线程数</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">AC_SHIFT</span> <span class="token operator">=</span> <span class="token number">48</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">AC_UNIT</span> <span class="token operator">=</span> <span class="token number">0</span>x0001L <span class="token operator">&lt;&lt;</span> <span class="token constant">AC_SHIFT</span><span class="token punctuation">;</span> <span class="token comment">//活跃线程数增量</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">AC_MASK</span> <span class="token operator">=</span> <span class="token number">0</span>xffffL <span class="token operator">&lt;&lt;</span> <span class="token constant">AC_SHIFT</span><span class="token punctuation">;</span> <span class="token comment">//活跃线程数掩码</span>

<span class="token comment">// 工作线程数</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TC_SHIFT</span> <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">TC_UNIT</span> <span class="token operator">=</span> <span class="token number">0</span>x0001L <span class="token operator">&lt;&lt;</span> <span class="token constant">TC_SHIFT</span><span class="token punctuation">;</span> <span class="token comment">//工作线程数增量</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">TC_MASK</span> <span class="token operator">=</span> <span class="token number">0</span>xffffL <span class="token operator">&lt;&lt;</span> <span class="token constant">TC_SHIFT</span><span class="token punctuation">;</span> <span class="token comment">//掩码</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">ADD_WORKER</span> <span class="token operator">=</span> <span class="token number">0</span>x0001L <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token constant">TC_SHIFT</span> <span class="token operator">+</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 创建工作线程标志</span>

<span class="token comment">// 池状态</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">RSLOCK</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">RSIGNAL</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">STARTED</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">STOP</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">29</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TERMINATED</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">30</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SHUTDOWN</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">31</span><span class="token punctuation">;</span>

<span class="token comment">// 实例字段</span>
<span class="token keyword">volatile</span> <span class="token keyword">long</span> ctl<span class="token punctuation">;</span>                   <span class="token comment">// 主控制参数</span>
<span class="token keyword">volatile</span> <span class="token keyword">int</span> runState<span class="token punctuation">;</span>               <span class="token comment">// 运行状态锁</span>
<span class="token keyword">final</span> <span class="token keyword">int</span> config<span class="token punctuation">;</span>                    <span class="token comment">// 并行度|模式</span>
<span class="token keyword">int</span> indexSeed<span class="token punctuation">;</span>                       <span class="token comment">// 用于生成工作线程索引</span>
<span class="token keyword">volatile</span> <span class="token class-name">WorkQueue</span><span class="token punctuation">[</span><span class="token punctuation">]</span> workQueues<span class="token punctuation">;</span>     <span class="token comment">// 主对象注册信息，workQueue</span>
<span class="token keyword">final</span> <span class="token class-name">ForkJoinWorkerThreadFactory</span> factory<span class="token punctuation">;</span><span class="token comment">// 线程工厂</span>
<span class="token keyword">final</span> <span class="token class-name">UncaughtExceptionHandler</span> ueh<span class="token punctuation">;</span>  <span class="token comment">// 每个工作线程的异常信息</span>
<span class="token keyword">final</span> <span class="token class-name">String</span> workerNamePrefix<span class="token punctuation">;</span>       <span class="token comment">// 用于创建工作线程的名称</span>
<span class="token keyword">volatile</span> <span class="token class-name">AtomicLong</span> stealCounter<span class="token punctuation">;</span>    <span class="token comment">// 偷取任务总数，也可作为同步监视器</span>

<span class="token comment">/** 静态初始化字段 */</span>
<span class="token comment">//线程工厂</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ForkJoinWorkerThreadFactory</span> defaultForkJoinWorkerThreadFactory<span class="token punctuation">;</span>
<span class="token comment">//启动或杀死线程的方法调用者的权限</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">RuntimePermission</span> modifyThreadPermission<span class="token punctuation">;</span>
<span class="token comment">// 公共静态pool</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ForkJoinPool</span> common<span class="token punctuation">;</span>
<span class="token comment">//并行度，对应内部common池</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> commonParallelism<span class="token punctuation">;</span>
<span class="token comment">//备用线程数，在tryCompensate中使用</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> commonMaxSpares<span class="token punctuation">;</span>
<span class="token comment">//创建workerNamePrefix(工作线程名称前缀)时的序号</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> poolNumberSequence<span class="token punctuation">;</span>
<span class="token comment">//线程阻塞等待新的任务的超时值(以纳秒为单位)，默认2秒</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">IDLE_TIMEOUT</span> <span class="token operator">=</span> <span class="token number">2000L</span> <span class="token operator">*</span> <span class="token number">1000L</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span> <span class="token comment">// 2sec</span>
<span class="token comment">//空闲超时时间，防止timer未命中</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">TIMEOUT_SLOP</span> <span class="token operator">=</span> <span class="token number">20L</span> <span class="token operator">*</span> <span class="token number">1000L</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>  <span class="token comment">// 20ms</span>
<span class="token comment">//默认备用线程数</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_COMMON_MAX_SPARES</span> <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>
<span class="token comment">//阻塞前自旋的次数，用在在awaitRunStateLock和awaitWork中</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SPINS</span>  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">//indexSeed的增量</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SEED_INCREMENT</span> <span class="token operator">=</span> <span class="token number">0x9e3779b9</span><span class="token punctuation">;</span>
</code></pre></div><p>说明: ForkJoinPool 的内部状态都是通过一个64位的 long 型 变量ctl来存储，它由四个16位的子域组成:</p> <ul><li>AC: 正在运行工作线程数减去目标并行度，高16位</li> <li>TC: 总工作线程数减去目标并行度，中高16位</li> <li>SS: 栈顶等待线程的版本计数和状态，中低16位</li> <li>ID: 栈顶 WorkQueue 在池中的索引(poolIndex)，低16位</li></ul> <p>在后面的源码解析中，某些地方也提取了ctl的低32位(sp=(int)ctl)来检查工作线程状态，例如，当sp不为0时说明当前还有空闲工作线程。</p> <h4 id="forkjoinpool-workqueue-中的相关属性"><a href="#forkjoinpool-workqueue-中的相关属性" class="header-anchor">#</a> ForkJoinPool.WorkQueue 中的相关属性:</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//初始队列容量，2的幂</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">INITIAL_QUEUE_CAPACITY</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">13</span><span class="token punctuation">;</span>
<span class="token comment">//最大队列容量</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MAXIMUM_QUEUE_CAPACITY</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">26</span><span class="token punctuation">;</span> <span class="token comment">// 64M</span>

<span class="token comment">// 实例字段</span>
<span class="token keyword">volatile</span> <span class="token keyword">int</span> scanState<span class="token punctuation">;</span>    <span class="token comment">// Woker状态, &lt;0: inactive; odd:scanning</span>
<span class="token keyword">int</span> stackPred<span class="token punctuation">;</span>             <span class="token comment">// 记录前一个栈顶的ctl</span>
<span class="token keyword">int</span> nsteals<span class="token punctuation">;</span>               <span class="token comment">// 偷取任务数</span>
<span class="token keyword">int</span> hint<span class="token punctuation">;</span>                  <span class="token comment">// 记录偷取者索引，初始为随机索引</span>
<span class="token keyword">int</span> config<span class="token punctuation">;</span>                <span class="token comment">// 池索引和模式</span>
<span class="token keyword">volatile</span> <span class="token keyword">int</span> qlock<span class="token punctuation">;</span>        <span class="token comment">// 1: locked, &lt; 0: terminate; else 0</span>
<span class="token keyword">volatile</span> <span class="token keyword">int</span> base<span class="token punctuation">;</span>         <span class="token comment">//下一个poll操作的索引(栈底/队列头)</span>
<span class="token keyword">int</span> top<span class="token punctuation">;</span>                   <span class="token comment">//  下一个push操作的索引(栈顶/队列尾)</span>
<span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">;</span>   <span class="token comment">// 任务数组</span>
<span class="token keyword">final</span> <span class="token class-name">ForkJoinPool</span> pool<span class="token punctuation">;</span>   <span class="token comment">// the containing pool (may be null)</span>
<span class="token keyword">final</span> <span class="token class-name">ForkJoinWorkerThread</span> owner<span class="token punctuation">;</span> <span class="token comment">// 当前工作队列的工作线程，共享模式下为null</span>
<span class="token keyword">volatile</span> <span class="token class-name">Thread</span> parker<span class="token punctuation">;</span>    <span class="token comment">// 调用park阻塞期间为owner，其他情况为null</span>
<span class="token keyword">volatile</span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> currentJoin<span class="token punctuation">;</span>  <span class="token comment">// 记录被join过来的任务</span>
<span class="token keyword">volatile</span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> currentSteal<span class="token punctuation">;</span> <span class="token comment">// 记录从其他工作队列偷取过来的任务</span>
</code></pre></div><h3 id="forkjointask"><a href="#forkjointask" class="header-anchor">#</a> ForkJoinTask</h3> <h4 id="核心参数-2"><a href="#核心参数-2" class="header-anchor">#</a> 核心参数</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/** 任务运行状态 */</span>
<span class="token keyword">volatile</span> <span class="token keyword">int</span> status<span class="token punctuation">;</span> <span class="token comment">// 任务运行状态</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DONE_MASK</span>   <span class="token operator">=</span> <span class="token number">0xf0000000</span><span class="token punctuation">;</span>  <span class="token comment">// 任务完成状态标志位</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">NORMAL</span>      <span class="token operator">=</span> <span class="token number">0xf0000000</span><span class="token punctuation">;</span>  <span class="token comment">// must be negative</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CANCELLED</span>   <span class="token operator">=</span> <span class="token number">0xc0000000</span><span class="token punctuation">;</span>  <span class="token comment">// must be &lt; NORMAL</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">EXCEPTIONAL</span> <span class="token operator">=</span> <span class="token number">0x80000000</span><span class="token punctuation">;</span>  <span class="token comment">// must be &lt; CANCELLED</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SIGNAL</span>      <span class="token operator">=</span> <span class="token number">0x00010000</span><span class="token punctuation">;</span>  <span class="token comment">// must be &gt;= 1 &lt;&lt; 16 等待信号</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SMASK</span>       <span class="token operator">=</span> <span class="token number">0x0000ffff</span><span class="token punctuation">;</span>  <span class="token comment">//  低位掩码</span>
</code></pre></div><h2 id="fork-join框架源码解析-2"><a href="#fork-join框架源码解析-2" class="header-anchor">#</a> Fork/Join框架源码解析</h2> <h3 id="构造函数"><a href="#构造函数" class="header-anchor">#</a> 构造函数</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> parallelism<span class="token punctuation">,</span>
                    <span class="token class-name">ForkJoinWorkerThreadFactory</span> factory<span class="token punctuation">,</span>
                    <span class="token class-name">UncaughtExceptionHandler</span> handler<span class="token punctuation">,</span>
                    <span class="token keyword">boolean</span> asyncMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token function">checkParallelism</span><span class="token punctuation">(</span>parallelism<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">checkFactory</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">,</span>
            handler<span class="token punctuation">,</span>
            asyncMode <span class="token operator">?</span> <span class="token constant">FIFO_QUEUE</span> <span class="token operator">:</span> <span class="token constant">LIFO_QUEUE</span><span class="token punctuation">,</span>
            <span class="token string">&quot;ForkJoinPool-&quot;</span> <span class="token operator">+</span> <span class="token function">nextPoolId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-worker-&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">checkPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>说明: 在 ForkJoinPool 中我们可以自定义四个参数:</p> <ul><li>parallelism: 并行度，默认为CPU数，最小为1</li> <li>factory: 工作线程工厂；</li> <li>handler: 处理工作线程运行任务时的异常情况类，默认为null；</li> <li>asyncMode: 是否为异步模式，默认为 false。如果为true，表示子任务的执行遵循 FIFO 顺序并且任务不能被合并(join)，这种模式适用于工作线程只运行事件类型的异步任务。</li></ul> <p>在多数场景使用时，如果没有太强的业务需求，我们一般直接使用 ForkJoinPool 中的common池，在JDK1.8之后提供了ForkJoinPool.commonPool()方法可以直接使用common池，来看一下它的构造:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ForkJoinPool</span> <span class="token function">makeCommonPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> parallelism <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token class-name">ForkJoinWorkerThreadFactory</span> factory <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">UncaughtExceptionHandler</span> handler <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>  <span class="token comment">// ignore exceptions in accessing/parsing</span>
        <span class="token class-name">String</span> pp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span>getProperty
                <span class="token punctuation">(</span><span class="token string">&quot;java.util.concurrent.ForkJoinPool.common.parallelism&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//并行度</span>
        <span class="token class-name">String</span> fp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span>getProperty
                <span class="token punctuation">(</span><span class="token string">&quot;java.util.concurrent.ForkJoinPool.common.threadFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//线程工厂</span>
        <span class="token class-name">String</span> hp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span>getProperty
                <span class="token punctuation">(</span><span class="token string">&quot;java.util.concurrent.ForkJoinPool.common.exceptionHandler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//异常处理类</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pp <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            parallelism <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fp <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            factory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinWorkerThreadFactory</span><span class="token punctuation">)</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span>
                    <span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hp <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            handler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">UncaughtExceptionHandler</span><span class="token punctuation">)</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span>
                    <span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>hp<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>factory <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            factory <span class="token operator">=</span> defaultForkJoinWorkerThreadFactory<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token comment">// use security-managed default</span>
            factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InnocuousForkJoinWorkerThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parallelism <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">// default 1 less than #cores</span>
            <span class="token punctuation">(</span>parallelism <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        parallelism <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//默认并行度为1</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parallelism <span class="token operator">&gt;</span> <span class="token constant">MAX_CAP</span><span class="token punctuation">)</span>
        parallelism <span class="token operator">=</span> <span class="token constant">MAX_CAP</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">(</span>parallelism<span class="token punctuation">,</span> factory<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> <span class="token constant">LIFO_QUEUE</span><span class="token punctuation">,</span>
            <span class="token string">&quot;ForkJoinPool.commonPool-worker-&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用common pool的优点就是我们可以通过指定系统参数的方式定义“并行度、线程工厂和异常处理类”；并且它使用的是同步模式，也就是说可以支持任务合并(join)。</p> <h3 id="执行流程-外部任务-external-submissions-task-提交"><a href="#执行流程-外部任务-external-submissions-task-提交" class="header-anchor">#</a> 执行流程 - 外部任务(external/submissions task)提交</h3> <p>向 ForkJoinPool 提交任务有三种方式:</p> <ul><li>invoke()会等待任务计算完毕并返回计算结果；</li> <li>execute()是直接向池提交一个任务来异步执行，无返回结果；</li> <li>submit()也是异步执行，但是会返回提交的任务，在适当的时候可通过task.get()获取执行结果。</li></ul> <p>这三种提交方式都都是调用externalPush()方法来完成，所以接下来我们将从externalPush()方法开始逐步分析外部任务的执行过程。</p> <h4 id="externalpush-forkjointask-task"><a href="#externalpush-forkjointask-task" class="header-anchor">#</a> externalPush(ForkJoinTask&lt;?&gt; task)</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//添加给定任务到submission队列中</span>
<span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">externalPush</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">WorkQueue</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ws<span class="token punctuation">;</span>
    <span class="token class-name">WorkQueue</span> q<span class="token punctuation">;</span>
    <span class="token keyword">int</span> m<span class="token punctuation">;</span>
    <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">getProbe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//探针值，用于计算WorkQueue槽位索引</span>
    <span class="token keyword">int</span> rs <span class="token operator">=</span> runState<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ws <span class="token operator">=</span> workQueues<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>m <span class="token operator">=</span> <span class="token punctuation">(</span>ws<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span>q <span class="token operator">=</span> ws<span class="token punctuation">[</span>m <span class="token operator">&amp;</span> r <span class="token operator">&amp;</span> <span class="token constant">SQMASK</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> r <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> rs <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">//获取随机偶数槽位的workQueue</span>
            <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token constant">QLOCK</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//锁定workQueue</span>
        <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">;</span>
        <span class="token keyword">int</span> am<span class="token punctuation">,</span> n<span class="token punctuation">,</span> s<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a <span class="token operator">=</span> q<span class="token punctuation">.</span>array<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
                <span class="token punctuation">(</span>am <span class="token operator">=</span> a<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> q<span class="token punctuation">.</span>top<span class="token punctuation">)</span> <span class="token operator">-</span> q<span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>am <span class="token operator">&amp;</span> s<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">ASHIFT</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">ABASE</span><span class="token punctuation">;</span><span class="token comment">//计算任务索引位置</span>
            <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putOrderedObject</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> j<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//任务入列</span>
            <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putOrderedInt</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token constant">QTOP</span><span class="token punctuation">,</span> s <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新push slot</span>
            <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putIntVolatile</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token constant">QLOCK</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//解除锁定</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token function">signalWork</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//任务数小于1时尝试创建或激活一个工作线程</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token constant">QLOCK</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//解除锁定</span>
    <span class="token punctuation">}</span>
    <span class="token function">externalSubmit</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化workQueues及相关属性</span>
<span class="token punctuation">}</span>
</code></pre></div><p>首先说明一下externalPush和externalSubmit两个方法的联系: 它们的作用都是把任务放到队列中等待执行。不同的是，externalSubmit可以说是完整版的externalPush，在任务首次提交时，需要初始化workQueues及其他相关属性，这个初始化操作就是externalSubmit来完成的；而后再向池中提交的任务都是通过简化版的externalSubmit-externalPush来完成。</p> <p>externalPush的执行流程很简单: 首先找到一个随机偶数槽位的 workQueue，然后把任务放入这个 workQueue 的任务数组中，并更新top位。如果队列的剩余任务数小于1，则尝试创建或激活一个工作线程来运行任务(防止在externalSubmit初始化时发生异常导致工作线程创建失败)。</p> <h4 id="externalsubmit-forkjointask-task"><a href="#externalsubmit-forkjointask-task" class="header-anchor">#</a> externalSubmit(ForkJoinTask&lt;?&gt; task)</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//任务提交</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">externalSubmit</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//初始化调用线程的探针值，用于计算WorkQueue索引</span>
    <span class="token keyword">int</span> r<span class="token punctuation">;</span>                                    <span class="token comment">// initialize caller's probe</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">=</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">getProbe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">localInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r <span class="token operator">=</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">getProbe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">WorkQueue</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ws<span class="token punctuation">;</span>
        <span class="token class-name">WorkQueue</span> q<span class="token punctuation">;</span>
        <span class="token keyword">int</span> rs<span class="token punctuation">,</span> m<span class="token punctuation">,</span> k<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> move <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rs <span class="token operator">=</span> runState<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 池已关闭</span>
            <span class="token function">tryTerminate</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// help terminate</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RejectedExecutionException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//初始化workQueues</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rs <span class="token operator">&amp;</span> <span class="token constant">STARTED</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span>     <span class="token comment">// initialize</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span>ws <span class="token operator">=</span> workQueues<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>m <span class="token operator">=</span> ws<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> ns <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            rs <span class="token operator">=</span> <span class="token function">lockRunState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//锁定runState</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//初始化</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rs <span class="token operator">&amp;</span> <span class="token constant">STARTED</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//初始化stealCounter</span>
                    <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">STEALCOUNTER</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                            <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//创建workQueues，容量为2的幂次方</span>
                    <span class="token comment">// create workQueues array with size a power of two</span>
                    <span class="token keyword">int</span> p <span class="token operator">=</span> config <span class="token operator">&amp;</span> <span class="token constant">SMASK</span><span class="token punctuation">;</span> <span class="token comment">// ensure at least 2 slots</span>
                    <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token punctuation">(</span>p <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> p <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    n <span class="token operator">|=</span> n <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    n <span class="token operator">|=</span> n <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">;</span>
                    n <span class="token operator">|=</span> n <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">;</span>
                    n <span class="token operator">|=</span> n <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">;</span>
                    n <span class="token operator">|=</span> n <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">;</span>
                    n <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    workQueues <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WorkQueue</span><span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    ns <span class="token operator">=</span> <span class="token constant">STARTED</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token function">unlockRunState</span><span class="token punctuation">(</span>rs<span class="token punctuation">,</span> <span class="token punctuation">(</span>rs <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token constant">RSLOCK</span><span class="token punctuation">)</span> <span class="token operator">|</span> ns<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//解锁并更新runState</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>q <span class="token operator">=</span> ws<span class="token punctuation">[</span>k <span class="token operator">=</span> r <span class="token operator">&amp;</span> m <span class="token operator">&amp;</span> <span class="token constant">SQMASK</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//获取随机偶数槽位的workQueue</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token punctuation">.</span>qlock <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token constant">QLOCK</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//锁定 workQueue</span>
                <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> a <span class="token operator">=</span> q<span class="token punctuation">.</span>array<span class="token punctuation">;</span><span class="token comment">//当前workQueue的全部任务</span>
                <span class="token keyword">int</span> s <span class="token operator">=</span> q<span class="token punctuation">.</span>top<span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> submitted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// initial submission or resizing</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>                      <span class="token comment">// locked version of push</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> s <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">-</span> q<span class="token punctuation">.</span>base<span class="token punctuation">)</span> <span class="token operator">||</span>
                            <span class="token punctuation">(</span>a <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">growArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//扩容</span>
                        <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> s<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">ASHIFT</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">ABASE</span><span class="token punctuation">;</span>
                        <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putOrderedObject</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> j<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//放入给定任务</span>
                        <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putOrderedInt</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token constant">QTOP</span><span class="token punctuation">,</span> s <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//修改push slot</span>
                        submitted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token constant">QLOCK</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//解除锁定</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>submitted<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//任务提交成功，创建或激活工作线程</span>
                    <span class="token function">signalWork</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建或激活一个工作线程来运行任务</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            move <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                   <span class="token comment">// move on failure 操作失败，重新获取探针值</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>rs <span class="token operator">=</span> runState<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token constant">RSLOCK</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// create new queue</span>
            q <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WorkQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            q<span class="token punctuation">.</span>hint <span class="token operator">=</span> r<span class="token punctuation">;</span>
            q<span class="token punctuation">.</span>config <span class="token operator">=</span> k <span class="token operator">|</span> <span class="token constant">SHARED_QUEUE</span><span class="token punctuation">;</span>
            q<span class="token punctuation">.</span>scanState <span class="token operator">=</span> <span class="token constant">INACTIVE</span><span class="token punctuation">;</span>
            rs <span class="token operator">=</span> <span class="token function">lockRunState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// publish index</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ws <span class="token operator">=</span> workQueues<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
                    k <span class="token operator">&lt;</span> ws<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> ws<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                ws<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> q<span class="token punctuation">;</span>                 <span class="token comment">// 更新索引k位值的workQueue</span>
            <span class="token comment">//else terminated</span>
            <span class="token function">unlockRunState</span><span class="token punctuation">(</span>rs<span class="token punctuation">,</span> rs <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token constant">RSLOCK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span>
            move <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                   <span class="token comment">// move if busy</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>move<span class="token punctuation">)</span>
            r <span class="token operator">=</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">advanceProbe</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//重新获取线程探针值</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>说明: externalSubmit是externalPush的完整版本，主要用于第一次提交任务时初始化workQueues及相关属性，并且提交给定任务到队列中。具体执行步骤如下:</p> <ul><li>如果池为终止状态(runState&lt;0)，调用tryTerminate来终止线程池，并抛出任务拒绝异常；</li> <li>如果尚未初始化，就为 FJP 执行初始化操作: 初始化stealCounter、创建workerQueues，然后继续自旋；</li> <li>初始化完成后，执行在externalPush中相同的操作: 获取 workQueue，放入指定任务。任务提交成功后调用signalWork方法创建或激活线程；</li> <li>如果在步骤3中获取到的 workQueue 为null，会在这一步中创建一个 workQueue，创建成功继续自旋执行第三步操作；</li> <li>如果非上述情况，或者有线程争用资源导致获取锁失败，就重新获取线程探针值继续自旋。</li></ul> <h4 id="signalwork-workqueue-ws-workqueue-q"><a href="#signalwork-workqueue-ws-workqueue-q" class="header-anchor">#</a> signalWork(WorkQueue[] ws, WorkQueue q)</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">signalWork</span><span class="token punctuation">(</span><span class="token class-name">WorkQueue</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ws<span class="token punctuation">,</span> <span class="token class-name">WorkQueue</span> q<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> c<span class="token punctuation">;</span>
    <span class="token keyword">int</span> sp<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
    <span class="token class-name">WorkQueue</span> v<span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> p<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> ctl<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                       <span class="token comment">// too few active</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> c<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                  <span class="token comment">// no idle workers</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">&amp;</span> <span class="token constant">ADD_WORKER</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0L</span><span class="token punctuation">)</span>            <span class="token comment">// too few workers</span>
                <span class="token function">tryAddWorker</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//工作线程太少，添加新的工作线程</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>                            <span class="token comment">// unstarted/terminated</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ws<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> sp <span class="token operator">&amp;</span> <span class="token constant">SMASK</span><span class="token punctuation">)</span><span class="token punctuation">)</span>         <span class="token comment">// terminated</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>v <span class="token operator">=</span> ws<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>                   <span class="token comment">// terminating</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token comment">//计算ctl，加上版本戳SS_SEQ避免ABA问题</span>
        <span class="token keyword">int</span> vs <span class="token operator">=</span> <span class="token punctuation">(</span>sp <span class="token operator">+</span> <span class="token constant">SS_SEQ</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token constant">INACTIVE</span><span class="token punctuation">;</span>        <span class="token comment">// next scanState</span>
        <span class="token keyword">int</span> d <span class="token operator">=</span> sp <span class="token operator">-</span> v<span class="token punctuation">.</span>scanState<span class="token punctuation">;</span>                  <span class="token comment">// screen CAS</span>
        <span class="token comment">//计算活跃线程数(高32位)并更新为下一个栈顶的scanState(低32位)</span>
        <span class="token keyword">long</span> nc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token constant">UC_MASK</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>c <span class="token operator">+</span> <span class="token constant">AC_UNIT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token constant">SP_MASK</span> <span class="token operator">&amp;</span> v<span class="token punctuation">.</span>stackPred<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>d <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">CTL</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> nc<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            v<span class="token punctuation">.</span>scanState <span class="token operator">=</span> vs<span class="token punctuation">;</span>                      <span class="token comment">// activate v</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> v<span class="token punctuation">.</span>parker<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//唤醒阻塞线程</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> q<span class="token punctuation">.</span>base <span class="token operator">==</span> q<span class="token punctuation">.</span>top<span class="token punctuation">)</span>          <span class="token comment">// no more work</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>说明: 新建或唤醒一个工作线程，在externalPush、externalSubmit、workQueue.push、scan中调用。如果还有空闲线程，则尝试唤醒索引到的 WorkQueue 的parker线程；如果工作线程过少((ctl &amp; ADD_WORKER) != 0L)，则调用tryAddWorker添加一个新的工作线程。</p> <h4 id="tryaddworker-long-c"><a href="#tryaddworker-long-c" class="header-anchor">#</a> tryAddWorker(long c)</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">tryAddWorker</span><span class="token punctuation">(</span><span class="token keyword">long</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> add <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> nc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token constant">AC_MASK</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>c <span class="token operator">+</span> <span class="token constant">AC_UNIT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span>
                   <span class="token punctuation">(</span><span class="token constant">TC_MASK</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>c <span class="token operator">+</span> <span class="token constant">TC_UNIT</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ctl <span class="token operator">==</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> rs<span class="token punctuation">,</span> stop<span class="token punctuation">;</span>                 <span class="token comment">// check if terminating</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>stop <span class="token operator">=</span> <span class="token punctuation">(</span>rs <span class="token operator">=</span> <span class="token function">lockRunState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token constant">STOP</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                add <span class="token operator">=</span> <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">CTL</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> nc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">unlockRunState</span><span class="token punctuation">(</span>rs<span class="token punctuation">,</span> rs <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token constant">RSLOCK</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//释放锁</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>stop <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>add<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">createWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建工作线程</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> ctl<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token constant">ADD_WORKER</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0L</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>说明: 尝试添加一个新的工作线程，首先更新ctl中的工作线程数，然后调用createWorker()创建工作线程。</p> <h4 id="createworker"><a href="#createworker" class="header-anchor">#</a> createWorker()</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">createWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ForkJoinWorkerThreadFactory</span> fac <span class="token operator">=</span> factory<span class="token punctuation">;</span>
    <span class="token class-name">Throwable</span> ex <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">ForkJoinWorkerThread</span> wt <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fac <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>wt <span class="token operator">=</span> fac<span class="token punctuation">.</span><span class="token function">newThread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            wt<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> rex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ex <span class="token operator">=</span> rex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">deregisterWorker</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//线程创建失败处理</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>说明: createWorker首先通过线程工厂创一个新的ForkJoinWorkerThread，然后启动这个工作线程(wt.start())。如果期间发生异常，调用deregisterWorker处理线程创建失败的逻辑(deregisterWorker在后面再详细说明)。</p> <p>ForkJoinWorkerThread 的构造函数如下:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">ForkJoinWorkerThread</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinPool</span> pool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Use a placeholder until a useful name can be set in registerWorker</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token string">&quot;aForkJoinWorkerThread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pool <span class="token operator">=</span> pool<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>workQueue <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">registerWorker</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到 ForkJoinWorkerThread 在构造时首先调用父类 Thread 的方法，然后为工作线程注册pool和workQueue，而workQueue的注册任务由ForkJoinPool.registerWorker来完成。</p> <h4 id="registerworker"><a href="#registerworker" class="header-anchor">#</a> registerWorker()</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">WorkQueue</span> <span class="token function">registerWorker</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinWorkerThread</span> wt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">UncaughtExceptionHandler</span> handler<span class="token punctuation">;</span>
    <span class="token comment">//设置为守护线程</span>
    wt<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">// configure thread</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>handler <span class="token operator">=</span> ueh<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        wt<span class="token punctuation">.</span><span class="token function">setUncaughtExceptionHandler</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">WorkQueue</span> w <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WorkQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> wt<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//构造新的WorkQueue</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                                    <span class="token comment">// assign a pool index</span>
    <span class="token keyword">int</span> mode <span class="token operator">=</span> config <span class="token operator">&amp;</span> <span class="token constant">MODE_MASK</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">lockRunState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">WorkQueue</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ws<span class="token punctuation">;</span>
        <span class="token keyword">int</span> n<span class="token punctuation">;</span>                    <span class="token comment">// skip if no array</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ws <span class="token operator">=</span> workQueues<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> ws<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//生成新建WorkQueue的索引</span>
            <span class="token keyword">int</span> s <span class="token operator">=</span> indexSeed <span class="token operator">+=</span> <span class="token constant">SEED_INCREMENT</span><span class="token punctuation">;</span>  <span class="token comment">// unlikely to collide</span>
            <span class="token keyword">int</span> m <span class="token operator">=</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            i <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> m<span class="token punctuation">;</span>               <span class="token comment">// Worker任务放在奇数索引位 odd-numbered indices</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ws<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                  <span class="token comment">// collision 已存在，重新计算索引位</span>
                <span class="token keyword">int</span> probes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                   <span class="token comment">// step by approx half n</span>
                <span class="token keyword">int</span> step <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token constant">EVENMASK</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token comment">//查找可用的索引位</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>ws<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> step<span class="token punctuation">)</span> <span class="token operator">&amp;</span> m<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>probes <span class="token operator">&gt;=</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//所有索引位都被占用，对workQueues进行扩容</span>
                        workQueues <span class="token operator">=</span> ws <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> n <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//workQueues 扩容</span>
                        m <span class="token operator">=</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                        probes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            w<span class="token punctuation">.</span>hint <span class="token operator">=</span> s<span class="token punctuation">;</span>                           <span class="token comment">// use as random seed</span>
            w<span class="token punctuation">.</span>config <span class="token operator">=</span> i <span class="token operator">|</span> mode<span class="token punctuation">;</span>
            w<span class="token punctuation">.</span>scanState <span class="token operator">=</span> i<span class="token punctuation">;</span>                      <span class="token comment">// publication fence</span>
            ws<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> w<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token function">unlockRunState</span><span class="token punctuation">(</span>rs<span class="token punctuation">,</span> rs <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token constant">RSLOCK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    wt<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>workerNamePrefix<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>i <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> w<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>说明: registerWorker是 ForkJoinWorkerThread 构造器的回调函数，用于创建和记录工作线程的 WorkQueue。比较简单，就不多赘述了。注意在此为工作线程创建的 WorkQueue 是放在奇数索引的(代码行: i = ((s &lt;&lt; 1) | 1) &amp; m;)</p> <h4 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h4> <p>OK，外部任务的提交流程就先讲到这里。在createWorker()中启动工作线程后(wt.start())，当为线程分配到CPU执行时间片之后会运行 ForkJoinWorkerThread 的run方法开启线程来执行任务。工作线程执行任务的流程我们在讲完内部任务提交之后会统一讲解。</p> <h3 id="执行流程-子任务-worker-task-提交"><a href="#执行流程-子任务-worker-task-提交" class="header-anchor">#</a> 执行流程: 子任务(Worker task)提交</h3> <p>子任务的提交相对比较简单，由任务的fork()方法完成。通过上面的流程图可以看到任务被分割(fork)之后调用了ForkJoinPool.WorkQueue.push()方法直接把任务放到队列中等待被执行。</p> <h4 id="forkjointask-fork"><a href="#forkjointask-fork" class="header-anchor">#</a> ForkJoinTask.fork()</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> t<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">ForkJoinWorkerThread</span><span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinWorkerThread</span><span class="token punctuation">)</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span>workQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>common<span class="token punctuation">.</span><span class="token function">externalPush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>说明: 如果当前线程是 Worker 线程，说明当前任务是fork分割的子任务，通过ForkJoinPool.workQueue.push()方法直接把任务放到自己的等待队列中；否则调用ForkJoinPool.externalPush()提交到一个随机的等待队列中(外部任务)。</p> <h4 id="forkjoinpool-workqueue-push"><a href="#forkjoinpool-workqueue-push" class="header-anchor">#</a> ForkJoinPool.WorkQueue.push()</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">;</span>
    <span class="token class-name">ForkJoinPool</span> p<span class="token punctuation">;</span>
    <span class="token keyword">int</span> b <span class="token operator">=</span> base<span class="token punctuation">,</span> s <span class="token operator">=</span> top<span class="token punctuation">,</span> n<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a <span class="token operator">=</span> array<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// ignore if queue removed</span>
        <span class="token keyword">int</span> m <span class="token operator">=</span> a<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>     <span class="token comment">// fenced write for task visibility</span>
        <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putOrderedObject</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m <span class="token operator">&amp;</span> s<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">ASHIFT</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">ABASE</span><span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putOrderedInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">QTOP</span><span class="token punctuation">,</span> s <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> s <span class="token operator">-</span> b<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//首次提交，创建或唤醒一个工作线程</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> pool<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                p<span class="token punctuation">.</span><span class="token function">signalWork</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>workQueues<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;=</span> m<span class="token punctuation">)</span>
            <span class="token function">growArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>说明: 首先把任务放入等待队列并更新top位；如果当前 WorkQueue 为新建的等待队列(top-base&lt;=1)，则调用signalWork方法为当前 WorkQueue 新建或唤醒一个工作线程；如果 WorkQueue 中的任务数组容量过小，则调用growArray()方法对其进行两倍扩容，growArray()方法源码如下:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">growArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> oldA <span class="token operator">=</span> array<span class="token punctuation">;</span><span class="token comment">//获取内部任务列表</span>
    <span class="token keyword">int</span> size <span class="token operator">=</span> oldA <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> oldA<span class="token punctuation">.</span>length <span class="token operator">&lt;&lt;</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token constant">INITIAL_QUEUE_CAPACITY</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> <span class="token constant">MAXIMUM_QUEUE_CAPACITY</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RejectedExecutionException</span><span class="token punctuation">(</span><span class="token string">&quot;Queue capacity exceeded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> oldMask<span class="token punctuation">,</span> t<span class="token punctuation">,</span> b<span class="token punctuation">;</span>
    <span class="token comment">//新建一个两倍容量的任务数组</span>
    <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> a <span class="token operator">=</span> array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldA <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>oldMask <span class="token operator">=</span> oldA<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span>t <span class="token operator">=</span> top<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>b <span class="token operator">=</span> base<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> mask <span class="token operator">=</span> size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">//从老数组中拿出数据，放到新的数组中</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span> <span class="token comment">// emulate poll from old array, push to new array</span>
            <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> x<span class="token punctuation">;</span>
            <span class="token keyword">int</span> oldj <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>b <span class="token operator">&amp;</span> oldMask<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">ASHIFT</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">ABASE</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>b <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">ASHIFT</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">ABASE</span><span class="token punctuation">;</span>
            x <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">getObjectVolatile</span><span class="token punctuation">(</span>oldA<span class="token punctuation">,</span> oldj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span>oldA<span class="token punctuation">,</span> oldj<span class="token punctuation">,</span> x<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putObjectVolatile</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> j<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">++</span>b <span class="token operator">!=</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> a<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="小结-2"><a href="#小结-2" class="header-anchor">#</a> 小结</h4> <p>到此，两种任务的提交流程都已经解析完毕，下一节我们来一起看看任务提交之后是如何被运行的。</p> <h3 id="执行流程-任务执行"><a href="#执行流程-任务执行" class="header-anchor">#</a> 执行流程: 任务执行</h3> <p>回到我们开始时的流程图，在ForkJoinPool .createWorker()方法中创建工作线程后，会启动工作线程，系统为工作线程分配到CPU执行时间片之后会执行 ForkJoinWorkerThread 的run()方法正式开始执行任务。</p> <h4 id="forkjoinworkerthread-run"><a href="#forkjoinworkerthread-run" class="header-anchor">#</a> ForkJoinWorkerThread.run()</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>workQueue<span class="token punctuation">.</span>array <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// only run once</span>
        <span class="token class-name">Throwable</span> exception <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//钩子方法，可自定义扩展</span>
            pool<span class="token punctuation">.</span><span class="token function">runWorker</span><span class="token punctuation">(</span>workQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            exception <span class="token operator">=</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token function">onTermination</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//钩子方法，可自定义扩展</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    exception <span class="token operator">=</span> ex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                pool<span class="token punctuation">.</span><span class="token function">deregisterWorker</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//处理异常</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>说明: 方法很简单，在工作线程运行前后会调用自定义钩子函数(onStart和onTermination)，任务的运行则是调用了ForkJoinPool.runWorker()。如果全部任务执行完毕或者期间遭遇异常，则通过ForkJoinPool.deregisterWorker关闭工作线程并处理异常信息(deregisterWorker方法我们后面会详细讲解)。</p> <h4 id="forkjoinpool-runworker-workqueue-w"><a href="#forkjoinpool-runworker-workqueue-w" class="header-anchor">#</a> ForkJoinPool.runWorker(WorkQueue w)</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">runWorker</span><span class="token punctuation">(</span><span class="token class-name">WorkQueue</span> w<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    w<span class="token punctuation">.</span><span class="token function">growArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// allocate queue</span>
    <span class="token keyword">int</span> seed <span class="token operator">=</span> w<span class="token punctuation">.</span>hint<span class="token punctuation">;</span>               <span class="token comment">// initially holds randomization hint</span>
    <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token punctuation">(</span>seed <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> seed<span class="token punctuation">;</span>  <span class="token comment">// avoid 0 for xorShift</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> t<span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t <span class="token operator">=</span> <span class="token function">scan</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token comment">//扫描任务执行</span>
            w<span class="token punctuation">.</span><span class="token function">runTask</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">awaitWork</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        r <span class="token operator">^=</span> r <span class="token operator">&lt;&lt;</span> <span class="token number">13</span><span class="token punctuation">;</span>
        r <span class="token operator">^=</span> r <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">17</span><span class="token punctuation">;</span>
        r <span class="token operator">^=</span> r <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// xorshift</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>说明: runWorker是 ForkJoinWorkerThread 的主运行方法，用来依次执行当前工作线程中的任务。函数流程很简单: 调用scan方法依次获取任务，然后调用WorkQueue .runTask运行任务；如果未扫描到任务，则调用awaitWork等待，直到工作线程/线程池终止或等待超时。</p> <h4 id="forkjoinpool-scan-workqueue-w-int-r"><a href="#forkjoinpool-scan-workqueue-w-int-r" class="header-anchor">#</a> ForkJoinPool.scan(WorkQueue w, int r)</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">scan</span><span class="token punctuation">(</span><span class="token class-name">WorkQueue</span> w<span class="token punctuation">,</span> <span class="token keyword">int</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">WorkQueue</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ws<span class="token punctuation">;</span>
    <span class="token keyword">int</span> m<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ws <span class="token operator">=</span> workQueues<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>m <span class="token operator">=</span> ws<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> w <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> ss <span class="token operator">=</span> w<span class="token punctuation">.</span>scanState<span class="token punctuation">;</span>                     <span class="token comment">// initially non-negative</span>
        <span class="token comment">//初始扫描起点，自旋扫描</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> origin <span class="token operator">=</span> r <span class="token operator">&amp;</span> m<span class="token punctuation">,</span> k <span class="token operator">=</span> origin<span class="token punctuation">,</span> oldSum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> checkSum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">WorkQueue</span> q<span class="token punctuation">;</span>
            <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">;</span>
            <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> t<span class="token punctuation">;</span>
            <span class="token keyword">int</span> b<span class="token punctuation">,</span> n<span class="token punctuation">;</span>
            <span class="token keyword">long</span> c<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>q <span class="token operator">=</span> ws<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//获取workQueue</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">=</span> q<span class="token punctuation">.</span>base<span class="token punctuation">)</span> <span class="token operator">-</span> q<span class="token punctuation">.</span>top<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                        <span class="token punctuation">(</span>a <span class="token operator">=</span> q<span class="token punctuation">.</span>array<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment">// non-empty</span>
                    <span class="token comment">//计算偏移量</span>
                    <span class="token keyword">long</span> i <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> b<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">ASHIFT</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">ABASE</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
                            <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">getObjectVolatile</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">//取base位置任务</span>
                            q<span class="token punctuation">.</span>base <span class="token operator">==</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//stable</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>ss <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//scanning</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> i<span class="token punctuation">,</span> t<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//</span>
                                q<span class="token punctuation">.</span>base <span class="token operator">=</span> b <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//更新base位</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>       <span class="token comment">// signal others</span>
                                    <span class="token function">signalWork</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建或唤醒工作线程来运行任务</span>
                                <span class="token keyword">return</span> t<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldSum <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>   <span class="token comment">// try to activate 尝试激活工作线程</span>
                                w<span class="token punctuation">.</span>scanState <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                            <span class="token function">tryRelease</span><span class="token punctuation">(</span>c <span class="token operator">=</span> ctl<span class="token punctuation">,</span> ws<span class="token punctuation">[</span>m <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> c<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">AC_UNIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//唤醒栈顶工作线程</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//base位置任务为空或base位置偏移，随机移位重新扫描</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ss <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>                   <span class="token comment">// refresh</span>
                        ss <span class="token operator">=</span> w<span class="token punctuation">.</span>scanState<span class="token punctuation">;</span>
                    r <span class="token operator">^=</span> r <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    r <span class="token operator">^=</span> r <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">3</span><span class="token punctuation">;</span>
                    r <span class="token operator">^=</span> r <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span>
                    origin <span class="token operator">=</span> k <span class="token operator">=</span> r <span class="token operator">&amp;</span> m<span class="token punctuation">;</span>           <span class="token comment">// move and rescan</span>
                    oldSum <span class="token operator">=</span> checkSum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                checkSum <span class="token operator">+=</span> b<span class="token punctuation">;</span><span class="token comment">//队列任务为空，记录base位</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//更新索引k 继续向后查找</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> <span class="token punctuation">(</span>k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> m<span class="token punctuation">)</span> <span class="token operator">==</span> origin<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// continue until stable</span>
                <span class="token comment">//运行到这里说明已经扫描了全部的 workQueues，但并未扫描到任务</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ss <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>ss <span class="token operator">==</span> <span class="token punctuation">(</span>ss <span class="token operator">=</span> w<span class="token punctuation">.</span>scanState<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                        oldSum <span class="token operator">==</span> <span class="token punctuation">(</span>oldSum <span class="token operator">=</span> checkSum<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ss <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> w<span class="token punctuation">.</span>qlock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token comment">// already inactive</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">// 已经被灭活或终止,跳出循环</span>

                    <span class="token comment">//对当前WorkQueue进行灭活操作</span>
                    <span class="token keyword">int</span> ns <span class="token operator">=</span> ss <span class="token operator">|</span> <span class="token constant">INACTIVE</span><span class="token punctuation">;</span>       <span class="token comment">// try to inactivate</span>
                    <span class="token keyword">long</span> nc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token constant">SP_MASK</span> <span class="token operator">&amp;</span> ns<span class="token punctuation">)</span> <span class="token operator">|</span>
                            <span class="token punctuation">(</span><span class="token constant">UC_MASK</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> ctl<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token constant">AC_UNIT</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//计算ctl为INACTIVE状态并减少活跃线程数</span>
                    w<span class="token punctuation">.</span>stackPred <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> c<span class="token punctuation">;</span>         <span class="token comment">// hold prev stack top</span>
                    <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token constant">QSCANSTATE</span><span class="token punctuation">,</span> ns<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//修改scanState为inactive状态</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">CTL</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> nc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//更新scanState为灭活状态</span>
                        ss <span class="token operator">=</span> ns<span class="token punctuation">;</span>
                    <span class="token keyword">else</span>
                        w<span class="token punctuation">.</span>scanState <span class="token operator">=</span> ss<span class="token punctuation">;</span>         <span class="token comment">// back out</span>
                <span class="token punctuation">}</span>
                checkSum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//重置checkSum，继续循环</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>说明: 扫描并尝试偷取一个任务。使用w.hint进行随机索引 WorkQueue，也就是说并不一定会执行当前 WorkQueue 中的任务，而是偷取别的Worker的任务来执行。</p> <p>函数的大概执行流程如下:</p> <ul><li><p>取随机位置的一个 WorkQueue；</p></li> <li><p>获取base位的 ForkJoinTask，成功取到后更新base位并返回任务；如果取到的 WorkQueue 中任务数大于1，则调用signalWork创建或唤醒其他工作线程；</p></li> <li><p>如果当前工作线程处于不活跃状态(INACTIVE)，则调用tryRelease尝试唤醒栈顶工作线程来执行。</p> <p>tryRelease源码如下:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">long</span> c<span class="token punctuation">,</span> <span class="token class-name">WorkQueue</span> v<span class="token punctuation">,</span> <span class="token keyword">long</span> inc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> sp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> c<span class="token punctuation">,</span> vs <span class="token operator">=</span> <span class="token punctuation">(</span>sp <span class="token operator">+</span> <span class="token constant">SS_SEQ</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token constant">INACTIVE</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> p<span class="token punctuation">;</span>
    <span class="token comment">//ctl低32位等于scanState，说明可以唤醒parker线程</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> v<span class="token punctuation">.</span>scanState <span class="token operator">==</span> sp<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token comment">// v is at top of stack</span>
        <span class="token comment">//计算活跃线程数(高32位)并更新为下一个栈顶的scanState(低32位)</span>
        <span class="token keyword">long</span> nc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token constant">UC_MASK</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>c <span class="token operator">+</span> inc<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token constant">SP_MASK</span> <span class="token operator">&amp;</span> v<span class="token punctuation">.</span>stackPred<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">CTL</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> nc<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            v<span class="token punctuation">.</span>scanState <span class="token operator">=</span> vs<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> v<span class="token punctuation">.</span>parker<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//唤醒线程</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>如果base位任务为空或发生偏移，则对索引位进行随机移位，然后重新扫描；</p></li> <li><p>如果扫描整个workQueues之后没有获取到任务，则设置当前工作线程为INACTIVE状态；然后重置checkSum，再次扫描一圈之后如果还没有任务则跳出循环返回null。</p></li></ul> <h4 id="forkjoinpool-awaitwork-workqueue-w-int-r"><a href="#forkjoinpool-awaitwork-workqueue-w-int-r" class="header-anchor">#</a> ForkJoinPool.awaitWork(WorkQueue w, int r)</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">awaitWork</span><span class="token punctuation">(</span><span class="token class-name">WorkQueue</span> w<span class="token punctuation">,</span> <span class="token keyword">int</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> w<span class="token punctuation">.</span>qlock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>                 <span class="token comment">// w is terminating</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> pred <span class="token operator">=</span> w<span class="token punctuation">.</span>stackPred<span class="token punctuation">,</span> spins <span class="token operator">=</span> <span class="token constant">SPINS</span><span class="token punctuation">,</span> ss<span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ss <span class="token operator">=</span> w<span class="token punctuation">.</span>scanState<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//正在扫描，跳出循环</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>spins <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r <span class="token operator">^=</span> r <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span>
            r <span class="token operator">^=</span> r <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">21</span><span class="token punctuation">;</span>
            r <span class="token operator">^=</span> r <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">--</span>spins <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token comment">// randomize spins</span>
                <span class="token class-name">WorkQueue</span> v<span class="token punctuation">;</span>
                <span class="token class-name">WorkQueue</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ws<span class="token punctuation">;</span>
                <span class="token keyword">int</span> s<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
                <span class="token class-name">AtomicLong</span> sc<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pred <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ws <span class="token operator">=</span> workQueues<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
                        <span class="token punctuation">(</span>j <span class="token operator">=</span> pred <span class="token operator">&amp;</span> <span class="token constant">SMASK</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> ws<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span>
                        <span class="token punctuation">(</span>v <span class="token operator">=</span> ws<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>        <span class="token comment">// see if pred parking</span>
                        <span class="token punctuation">(</span>v<span class="token punctuation">.</span>parker <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> v<span class="token punctuation">.</span>scanState <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    spins <span class="token operator">=</span> <span class="token constant">SPINS</span><span class="token punctuation">;</span>                <span class="token comment">// continue spinning</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>w<span class="token punctuation">.</span>qlock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>                     <span class="token comment">// 当前workQueue已经终止，返回false recheck after spins</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//判断线程是否被中断，并清除中断状态</span>
            <span class="token keyword">long</span> c<span class="token punctuation">,</span> prevctl<span class="token punctuation">,</span> parkTime<span class="token punctuation">,</span> deadline<span class="token punctuation">;</span>
            <span class="token keyword">int</span> ac <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> ctl<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token constant">AC_SHIFT</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>config <span class="token operator">&amp;</span> <span class="token constant">SMASK</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//活跃线程数</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ac <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">tryTerminate</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token comment">//无active线程，尝试终止</span>
                    <span class="token punctuation">(</span>runState <span class="token operator">&amp;</span> <span class="token constant">STOP</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>           <span class="token comment">// pool terminating</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ac <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> ss <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// is last waiter</span>
                <span class="token comment">//计算活跃线程数(高32位)并更新为下一个栈顶的scanState(低32位)</span>
                prevctl <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token constant">UC_MASK</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>c <span class="token operator">+</span> <span class="token constant">AC_UNIT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token constant">SP_MASK</span> <span class="token operator">&amp;</span> pred<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>c <span class="token operator">&gt;&gt;&gt;</span> <span class="token constant">TC_SHIFT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// shrink excess spares</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">CTL</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> prevctl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//总线程过量</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                 <span class="token comment">// else use timed wait</span>
                <span class="token comment">//计算空闲超时时间</span>
                parkTime <span class="token operator">=</span> <span class="token constant">IDLE_TIMEOUT</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">1</span> <span class="token operator">-</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                deadline <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> parkTime <span class="token operator">-</span> <span class="token constant">TIMEOUT_SLOP</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span>
                prevctl <span class="token operator">=</span> parkTime <span class="token operator">=</span> deadline <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span> wt <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> <span class="token constant">PARKBLOCKER</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// emulate LockSupport</span>
            w<span class="token punctuation">.</span>parker <span class="token operator">=</span> wt<span class="token punctuation">;</span><span class="token comment">//设置parker，准备阻塞</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>w<span class="token punctuation">.</span>scanState <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> ctl <span class="token operator">==</span> c<span class="token punctuation">)</span>      <span class="token comment">// recheck before park</span>
                <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> parkTime<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//阻塞指定的时间</span>

            <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putOrderedObject</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token constant">QPARKER</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> <span class="token constant">PARKBLOCKER</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>w<span class="token punctuation">.</span>scanState <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//正在扫描，说明等到任务，跳出循环</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>parkTime <span class="token operator">!=</span> <span class="token number">0L</span> <span class="token operator">&amp;&amp;</span> ctl <span class="token operator">==</span> c <span class="token operator">&amp;&amp;</span>
                    deadline <span class="token operator">-</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0L</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">CTL</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> prevctl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//未等到任务，更新ctl，返回false</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                     <span class="token comment">// shrink pool</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>说明: 回到runWorker方法，如果scan方法未扫描到任务，会调用awaitWork等待获取任务。函数的具体执行流程大家看源码，这里简单说一下:</p> <ul><li>在等待获取任务期间，如果工作线程或线程池已经终止则直接返回false。如果当前无 active 线程，尝试终止线程池并返回false，如果终止失败并且当前是最后一个等待的 Worker，就阻塞指定的时间(IDLE_TIMEOUT)；等到届期或被唤醒后如果发现自己是scanning(scanState &gt;= 0)状态，说明已经等到任务，跳出等待返回true继续 scan，否则的更新ctl并返回false。</li></ul> <h4 id="workqueue-runtask"><a href="#workqueue-runtask" class="header-anchor">#</a> WorkQueue.runTask()</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">runTask</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        scanState <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token constant">SCANNING</span><span class="token punctuation">;</span> <span class="token comment">// mark as busy</span>
        <span class="token punctuation">(</span>currentSteal <span class="token operator">=</span> task<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新currentSteal并执行任务</span>
        <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putOrderedObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">QCURRENTSTEAL</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// release for GC</span>
        <span class="token function">execLocalTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//依次执行本地任务</span>
        <span class="token class-name">ForkJoinWorkerThread</span> thread <span class="token operator">=</span> owner<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>nsteals <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>      <span class="token comment">// collect on overflow</span>
            <span class="token function">transferStealCount</span><span class="token punctuation">(</span>pool<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//增加偷取任务数</span>
        scanState <span class="token operator">|=</span> <span class="token constant">SCANNING</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>thread <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            thread<span class="token punctuation">.</span><span class="token function">afterTopLevelExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行钩子函数</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>说明: 在scan方法扫描到任务之后，调用WorkQueue.runTask()来执行获取到的任务，大概流程如下:</p> <ul><li><p>标记scanState为正在执行状态；</p></li> <li><p>更新currentSteal为当前获取到的任务并执行它，任务的执行调用了ForkJoinTask.doExec()方法，源码如下:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//ForkJoinTask.doExec()</span>
<span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">doExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> s<span class="token punctuation">;</span> <span class="token keyword">boolean</span> completed<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> status<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            completed <span class="token operator">=</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行我们定义的任务</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> rex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">setExceptionalCompletion</span><span class="token punctuation">(</span>rex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>completed<span class="token punctuation">)</span>
            s <span class="token operator">=</span> <span class="token function">setCompletion</span><span class="token punctuation">(</span><span class="token constant">NORMAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>调用execLocalTasks依次执行当前WorkerQueue中的任务，源码如下:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//执行并移除所有本地任务</span>
<span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">execLocalTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> b <span class="token operator">=</span> base<span class="token punctuation">,</span> m<span class="token punctuation">,</span> s<span class="token punctuation">;</span>
    <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> a <span class="token operator">=</span> array<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">-</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> top <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> a <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span>m <span class="token operator">=</span> a<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>config <span class="token operator">&amp;</span> <span class="token constant">FIFO_QUEUE</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//FIFO模式</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> t<span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token class-name">U</span><span class="token punctuation">.</span>getAndSetObject
                        <span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m <span class="token operator">&amp;</span> s<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">ASHIFT</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">ABASE</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token comment">//FIFO执行，取top任务</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putOrderedInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">QTOP</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
                t<span class="token punctuation">.</span><span class="token function">doExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>base <span class="token operator">-</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> top <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span>
            <span class="token function">pollAndExecAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//LIFO模式执行，取base任务</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>更新偷取任务数；</p></li> <li><p>还原scanState并执行钩子函数。</p></li></ul> <h4 id="forkjoinpool-deregisterworker-forkjoinworkerthread-wt-throwable-ex"><a href="#forkjoinpool-deregisterworker-forkjoinworkerthread-wt-throwable-ex" class="header-anchor">#</a> ForkJoinPool.deregisterWorker(ForkJoinWorkerThread wt, Throwable ex)</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">deregisterWorker</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinWorkerThread</span> wt<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">WorkQueue</span> w <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">//1.移除workQueue</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>wt <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>w <span class="token operator">=</span> wt<span class="token punctuation">.</span>workQueue<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//获取ForkJoinWorkerThread的等待队列</span>
        <span class="token class-name">WorkQueue</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ws<span class="token punctuation">;</span>                           <span class="token comment">// remove index from array</span>
        <span class="token keyword">int</span> idx <span class="token operator">=</span> w<span class="token punctuation">.</span>config <span class="token operator">&amp;</span> <span class="token constant">SMASK</span><span class="token punctuation">;</span><span class="token comment">//计算workQueue索引</span>
        <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">lockRunState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取runState锁和当前池运行状态</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ws <span class="token operator">=</span> workQueues<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> ws<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> idx <span class="token operator">&amp;&amp;</span> ws<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">==</span> w<span class="token punctuation">)</span>
            ws<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">//移除workQueue</span>
        <span class="token function">unlockRunState</span><span class="token punctuation">(</span>rs<span class="token punctuation">,</span> rs <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token constant">RSLOCK</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//解除runState锁</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//2.减少CTL数</span>
    <span class="token keyword">long</span> c<span class="token punctuation">;</span>                                       <span class="token comment">// decrement counts</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">U</span><span class="token punctuation">.</span>compareAndSwapLong
                 <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">CTL</span><span class="token punctuation">,</span> c <span class="token operator">=</span> ctl<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token constant">AC_MASK</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>c <span class="token operator">-</span> <span class="token constant">AC_UNIT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span>
                                       <span class="token punctuation">(</span><span class="token constant">TC_MASK</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>c <span class="token operator">-</span> <span class="token constant">TC_UNIT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span>
                                       <span class="token punctuation">(</span><span class="token constant">SP_MASK</span> <span class="token operator">&amp;</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3.处理被移除workQueue内部相关参数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        w<span class="token punctuation">.</span>qlock <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>                             <span class="token comment">// ensure set</span>
        w<span class="token punctuation">.</span><span class="token function">transferStealCount</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w<span class="token punctuation">.</span><span class="token function">cancelAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">// cancel remaining tasks</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//4.如果线程未终止，替换被移除的workQueue并唤醒内部线程</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                    <span class="token comment">// possibly replace</span>
        <span class="token class-name">WorkQueue</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ws<span class="token punctuation">;</span> <span class="token keyword">int</span> m<span class="token punctuation">,</span> sp<span class="token punctuation">;</span>
        <span class="token comment">//尝试终止线程池</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryTerminate</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">||</span> w <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> w<span class="token punctuation">.</span>array <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span>
            <span class="token punctuation">(</span>runState <span class="token operator">&amp;</span> <span class="token constant">STOP</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>ws <span class="token operator">=</span> workQueues<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span>
            <span class="token punctuation">(</span>m <span class="token operator">=</span> ws<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>              <span class="token comment">// already terminating</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token comment">//唤醒被替换的线程，依赖于下一步</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>c <span class="token operator">=</span> ctl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token comment">// wake up replacement</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryRelease</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> ws<span class="token punctuation">[</span>sp <span class="token operator">&amp;</span> m<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">AC_UNIT</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//创建工作线程替换</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>c <span class="token operator">&amp;</span> <span class="token constant">ADD_WORKER</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">tryAddWorker</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">// create replacement</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>                                      <span class="token comment">// don't need replacement</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//5.处理异常</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>                               <span class="token comment">// help clean on way out</span>
        <span class="token class-name">ForkJoinTask</span><span class="token punctuation">.</span><span class="token function">helpExpungeStaleExceptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>                                          <span class="token comment">// rethrow</span>
        <span class="token class-name">ForkJoinTask</span><span class="token punctuation">.</span><span class="token function">rethrow</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>说明: deregisterWorker方法用于工作线程运行完毕之后终止线程或处理工作线程异常，主要就是清除已关闭的工作线程或回滚创建线程之前的操作，并把传入的异常抛给 ForkJoinTask 来处理。具体步骤见源码注释。</p> <h4 id="小结-3"><a href="#小结-3" class="header-anchor">#</a> 小结</h4> <p>本节我们对任务的执行流程进行了说明，后面我们将继续介绍任务的结果获取(join/invoke)。</p> <h3 id="获取任务结果-forkjointask-join-forkjointask-invoke"><a href="#获取任务结果-forkjointask-join-forkjointask-invoke" class="header-anchor">#</a> 获取任务结果 - ForkJoinTask.join() / ForkJoinTask.invoke()</h3> <ul><li>join() :</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//合并任务结果</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">V</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> s<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> <span class="token function">doJoin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token constant">DONE_MASK</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NORMAL</span><span class="token punctuation">)</span>
        <span class="token function">reportException</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">getRawResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//join, get, quietlyJoin的主实现方法</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">doJoin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> s<span class="token punctuation">;</span> <span class="token class-name">Thread</span> t<span class="token punctuation">;</span> <span class="token class-name">ForkJoinWorkerThread</span> wt<span class="token punctuation">;</span> <span class="token class-name">ForkJoinPool<span class="token punctuation">.</span>WorkQueue</span> w<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> status<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> s <span class="token operator">:</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span>t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">ForkJoinWorkerThread</span><span class="token punctuation">)</span> <span class="token operator">?</span>
        <span class="token punctuation">(</span>w <span class="token operator">=</span> <span class="token punctuation">(</span>wt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ForkJoinWorkerThread</span><span class="token punctuation">)</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span>workQueue<span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">tryUnpush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> <span class="token function">doExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> s <span class="token operator">:</span>
        wt<span class="token punctuation">.</span>pool<span class="token punctuation">.</span><span class="token function">awaitJoin</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token operator">:</span>
        <span class="token function">externalAwaitDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>invoke() :</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//执行任务，并等待任务完成并返回结果</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">V</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> s<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> <span class="token function">doInvoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token constant">DONE_MASK</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NORMAL</span><span class="token punctuation">)</span>
        <span class="token function">reportException</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">getRawResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//invoke, quietlyInvoke的主实现方法</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">doInvoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> s<span class="token punctuation">;</span> <span class="token class-name">Thread</span> t<span class="token punctuation">;</span> <span class="token class-name">ForkJoinWorkerThread</span> wt<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> <span class="token function">doExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> s <span class="token operator">:</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span>t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">ForkJoinWorkerThread</span><span class="token punctuation">)</span> <span class="token operator">?</span>
        <span class="token punctuation">(</span>wt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ForkJoinWorkerThread</span><span class="token punctuation">)</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span>pool<span class="token punctuation">.</span>
        <span class="token function">awaitJoin</span><span class="token punctuation">(</span>wt<span class="token punctuation">.</span>workQueue<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token operator">:</span>
        <span class="token function">externalAwaitDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>说明: join()方法一把是在任务fork()之后调用，用来获取(或者叫“合并”)任务的执行结果。</p> <p>ForkJoinTask的join()和invoke()方法都可以用来获取任务的执行结果(另外还有get方法也是调用了doJoin来获取任务结果，但是会响应运行时异常)，它们对外部提交任务的执行方式一致，都是通过externalAwaitDone方法等待执行结果。不同的是invoke()方法会直接执行当前任务；而join()方法则是在当前任务在队列 top 位时(通过tryUnpush方法判断)才能执行，如果当前任务不在 top 位或者任务执行失败调用ForkJoinPool.awaitJoin方法帮助执行或阻塞当前 join 任务。(所以在官方文档中建议了我们对ForkJoinTask任务的调用顺序，一对 fork-join操作一般按照如下顺序调用: a.fork(); b.fork(); b.join(); a.join();。因为任务 b 是后面进入队列，也就是说它是在栈顶的(top 位)，在它fork()之后直接调用join()就可以直接执行而不会调用ForkJoinPool.awaitJoin方法去等待。)</p> <p>在这些方法中，join()相对比较全面，所以之后的讲解我们将从join()开始逐步向下分析，首先看一下join()的执行流程:</p> <p><img src="https://raw.githubusercontent.com/lowskylee/Pictures/main/images/java-thread-x-forkjoin-6.png" alt=""></p> <p>后面的源码分析中，我们首先讲解比较简单的外部 join 任务(externalAwaitDone)，然后再讲解内部 join 任务(从ForkJoinPool.awaitJoin()开始)。</p> <h4 id="forkjointask-externalawaitdone"><a href="#forkjointask-externalawaitdone" class="header-anchor">#</a> ForkJoinTask.externalAwaitDone()</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">externalAwaitDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//执行任务</span>
    <span class="token keyword">int</span> s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">CountedCompleter</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token comment">// try helping</span>
             <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>common<span class="token punctuation">.</span><span class="token function">externalHelpComplete</span><span class="token punctuation">(</span>  <span class="token comment">// CountedCompleter任务</span>
                 <span class="token punctuation">(</span><span class="token class-name">CountedCompleter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">:</span>
             <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>common<span class="token punctuation">.</span><span class="token function">tryExternalUnpush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">doExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ForkJoinTask任务</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> status<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//执行失败，进入等待</span>
        <span class="token keyword">boolean</span> interrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">STATUS</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> s <span class="token operator">|</span> <span class="token constant">SIGNAL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//更新state</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//SIGNAL 等待信号</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            interrupted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span>
                        <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> status<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>interrupted<span class="token punctuation">)</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>说明: 如果当前join为外部调用，则调用此方法执行任务，如果任务执行失败就进入等待。方法本身是很简单的，需要注意的是对不同的任务类型分两种情况:</p> <ul><li><p>如果我们的任务为 CountedCompleter 类型的任务，则调用externalHelpComplete方法来执行任务。</p></li> <li><p>其他类型的 ForkJoinTask 任务调用tryExternalUnpush来执行，源码如下:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//为外部提交者提供 tryUnpush 功能(给定任务在top位时弹出任务)</span>
<span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryExternalUnpush</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">WorkQueue</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ws<span class="token punctuation">;</span>
    <span class="token class-name">WorkQueue</span> w<span class="token punctuation">;</span>
    <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">;</span>
    <span class="token keyword">int</span> m<span class="token punctuation">,</span> s<span class="token punctuation">;</span>
    <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">getProbe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ws <span class="token operator">=</span> workQueues<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>m <span class="token operator">=</span> ws<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span>w <span class="token operator">=</span> ws<span class="token punctuation">[</span>m <span class="token operator">&amp;</span> r <span class="token operator">&amp;</span> <span class="token constant">SQMASK</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span>a <span class="token operator">=</span> w<span class="token punctuation">.</span>array<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> w<span class="token punctuation">.</span>top<span class="token punctuation">)</span> <span class="token operator">!=</span> w<span class="token punctuation">.</span>base<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> j <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>s <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">ASHIFT</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">ABASE</span><span class="token punctuation">;</span>  <span class="token comment">//取top位任务</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token constant">QLOCK</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//加锁</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>w<span class="token punctuation">.</span>top <span class="token operator">==</span> s <span class="token operator">&amp;&amp;</span> w<span class="token punctuation">.</span>array <span class="token operator">==</span> a <span class="token operator">&amp;&amp;</span>
                    <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> j<span class="token punctuation">)</span> <span class="token operator">==</span> task <span class="token operator">&amp;&amp;</span>
                    <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> j<span class="token punctuation">,</span> task<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//符合条件，弹出</span>
                <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putOrderedInt</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token constant">QTOP</span><span class="token punctuation">,</span> s <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//更新top</span>
                <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putOrderedInt</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token constant">QLOCK</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//解锁，返回true</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token constant">QLOCK</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//当前任务不在top位，解锁返回false</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>tryExternalUnpush的作用就是判断当前任务是否在top位，如果是则弹出任务，然后在externalAwaitDone中调用doExec()执行任务。</p></li></ul> <h4 id="forkjoinpool-awaitjoin"><a href="#forkjoinpool-awaitjoin" class="header-anchor">#</a> ForkJoinPool.awaitJoin()</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">awaitJoin</span><span class="token punctuation">(</span><span class="token class-name">WorkQueue</span> w<span class="token punctuation">,</span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> task<span class="token punctuation">,</span> <span class="token keyword">long</span> deadline<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> s <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> w <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> prevJoin <span class="token operator">=</span> w<span class="token punctuation">.</span>currentJoin<span class="token punctuation">;</span>  <span class="token comment">//获取给定Worker的join任务</span>
        <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putOrderedObject</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token constant">QCURRENTJOIN</span><span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//把currentJoin替换为给定任务</span>
        <span class="token comment">//判断是否为CountedCompleter类型的任务</span>
        <span class="token class-name">CountedCompleter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> cc <span class="token operator">=</span> <span class="token punctuation">(</span>task <span class="token keyword">instanceof</span> <span class="token class-name">CountedCompleter</span><span class="token punctuation">)</span> <span class="token operator">?</span>
                <span class="token punctuation">(</span><span class="token class-name">CountedCompleter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> task <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> task<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">//已经完成|取消|异常 跳出循环</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>cc <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token comment">//CountedCompleter任务由helpComplete来完成join</span>
                <span class="token function">helpComplete</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> cc<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>w<span class="token punctuation">.</span>base <span class="token operator">==</span> w<span class="token punctuation">.</span>top <span class="token operator">||</span> w<span class="token punctuation">.</span><span class="token function">tryRemoveAndExec</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//尝试执行</span>
                <span class="token function">helpStealer</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//队列为空或执行失败，任务可能被偷，帮助偷取者执行该任务</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> task<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//已经完成|取消|异常，跳出循环</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token comment">//计算任务等待时间</span>
            <span class="token keyword">long</span> ms<span class="token punctuation">,</span> ns<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>deadline <span class="token operator">==</span> <span class="token number">0L</span><span class="token punctuation">)</span>
                ms <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ns <span class="token operator">=</span> deadline <span class="token operator">-</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0L</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ms <span class="token operator">=</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">NANOSECONDS</span><span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>ns<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0L</span><span class="token punctuation">)</span>
                ms <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryCompensate</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//执行补偿操作</span>
                task<span class="token punctuation">.</span><span class="token function">internalWait</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//补偿执行成功，任务等待指定时间</span>
                <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">getAndAddLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">CTL</span><span class="token punctuation">,</span> <span class="token constant">AC_UNIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新活跃线程数</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putOrderedObject</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token constant">QCURRENTJOIN</span><span class="token punctuation">,</span> prevJoin<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//循环结束，替换为原来的join任务</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>说明: 如果当前 join 任务不在Worker等待队列的top位，或者任务执行失败，调用此方法来帮助执行或阻塞当前 join 的任务。函数执行流程如下:</p> <ul><li><p>由于每次调用awaitJoin都会优先执行当前join的任务，所以首先会更新currentJoin为当前join任务；</p></li> <li><p>进入自旋:</p> <ul><li>首先检查任务是否已经完成(通过task.status &lt; 0判断)，如果给定任务执行完毕|取消|异常 则跳出循环返回执行状态s；</li> <li>如果是 CountedCompleter 任务类型，调用helpComplete方法来完成join操作(后面笔者会开新篇来专门讲解CountedCompleter，本篇暂时不做详细解析)；</li> <li>非 CountedCompleter 任务类型调用WorkQueue.tryRemoveAndExec尝试执行任务；</li> <li>如果给定 WorkQueue 的等待队列为空或任务执行失败，说明任务可能被偷，调用helpStealer帮助偷取者执行任务(也就是说，偷取者帮我执行任务，我去帮偷取者执行它的任务)；</li> <li>再次判断任务是否执行完毕(task.status &lt; 0)，如果任务执行失败，计算一个等待时间准备进行补偿操作；</li> <li>调用tryCompensate方法为给定 WorkQueue 尝试执行补偿操作。在执行补偿期间，如果发现 资源争用|池处于unstable状态|当前Worker已终止，则调用ForkJoinTask.internalWait()方法等待指定的时间，任务唤醒之后继续自旋，ForkJoinTask.internalWait()源码如下:</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">internalWait</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> s<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> status<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">// force completer to issue notify</span>
        <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">STATUS</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> s <span class="token operator">|</span> <span class="token constant">SIGNAL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//更新任务状态为SIGNAL(等待唤醒)</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span> <span class="token function">wait</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
                <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <p>在awaitJoin中，我们总共调用了三个比较复杂的方法: tryRemoveAndExec、helpStealer和tryCompensate，下面我们依次讲解。</p> <h4 id="workqueue-tryremoveandexec-forkjointask-task"><a href="#workqueue-tryremoveandexec-forkjointask-task" class="header-anchor">#</a> WorkQueue.tryRemoveAndExec(ForkJoinTask&lt;?&gt; task)</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryRemoveAndExec</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">;</span>
    <span class="token keyword">int</span> m<span class="token punctuation">,</span> s<span class="token punctuation">,</span> b<span class="token punctuation">,</span> n<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a <span class="token operator">=</span> array<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>m <span class="token operator">=</span> a<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
            task <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> top<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>b <span class="token operator">=</span> base<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//从top往下自旋查找</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> t<span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment">// traverse from s to b</span>
                <span class="token keyword">long</span> j <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">--</span>s <span class="token operator">&amp;</span> m<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">ASHIFT</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">ABASE</span><span class="token punctuation">;</span><span class="token comment">//计算任务索引</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">//获取索引到的任务</span>
                    <span class="token keyword">return</span> s <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">==</span> top<span class="token punctuation">;</span>     <span class="token comment">// shorter than expected</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//给定任务为索引任务</span>
                    <span class="token keyword">boolean</span> removed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">==</span> top<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment">// pop</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> j<span class="token punctuation">,</span> task<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//弹出任务</span>
                            <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putOrderedInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">QTOP</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//更新top</span>
                            removed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>base <span class="token operator">==</span> b<span class="token punctuation">)</span>      <span class="token comment">// replace with proxy</span>
                        removed <span class="token operator">=</span> <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span>
                                a<span class="token punctuation">,</span> j<span class="token punctuation">,</span> task<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">EmptyTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//join任务已经被移除，替换为一个占位任务</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>removed<span class="token punctuation">)</span>
                        task<span class="token punctuation">.</span><span class="token function">doExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//执行</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> s <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">==</span> top<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//给定任务不是top任务</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> j<span class="token punctuation">,</span> t<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//弹出任务</span>
                        <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putOrderedInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">QTOP</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新top</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>                  <span class="token comment">// was cancelled</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>n <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//遍历结束</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//任务执行完毕</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>说明: 从top位开始自旋向下找到给定任务，如果找到把它从当前 Worker 的任务队列中移除并执行它。注意返回的参数: 如果任务队列为空或者任务未执行完毕返回true；任务执行完毕返回false。</p> <h4 id="forkjoinpool-helpstealer-workqueue-w-forkjointask-task"><a href="#forkjoinpool-helpstealer-workqueue-w-forkjointask-task" class="header-anchor">#</a> ForkJoinPool.helpStealer(WorkQueue w, ForkJoinTask&lt;?&gt; task)</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">helpStealer</span><span class="token punctuation">(</span><span class="token class-name">WorkQueue</span> w<span class="token punctuation">,</span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">WorkQueue</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ws <span class="token operator">=</span> workQueues<span class="token punctuation">;</span>
    <span class="token keyword">int</span> oldSum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> checkSum<span class="token punctuation">,</span> m<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>m <span class="token operator">=</span> ws<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> w <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
            task <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>                                       <span class="token comment">// restart point</span>
            checkSum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                          <span class="token comment">// for stability check</span>
            <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> subtask<span class="token punctuation">;</span>
            <span class="token class-name">WorkQueue</span> j <span class="token operator">=</span> w<span class="token punctuation">,</span> v<span class="token punctuation">;</span>                    <span class="token comment">// v is subtask stealer</span>
            descent<span class="token operator">:</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>subtask <span class="token operator">=</span> task<span class="token punctuation">;</span> subtask<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//1. 找到给定WorkQueue的偷取者v</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> h <span class="token operator">=</span> j<span class="token punctuation">.</span>hint <span class="token operator">|</span> <span class="token number">1</span><span class="token punctuation">,</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">;</span> <span class="token punctuation">;</span> k <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//跳两个索引，因为Worker在奇数索引位</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">&gt;</span> m<span class="token punctuation">)</span>                     <span class="token comment">// can't find stealer</span>
                        <span class="token keyword">break</span> descent<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>v <span class="token operator">=</span> ws<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token punctuation">(</span>h <span class="token operator">+</span> k<span class="token punctuation">)</span> <span class="token operator">&amp;</span> m<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>v<span class="token punctuation">.</span>currentSteal <span class="token operator">==</span> subtask<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//定位到偷取者</span>
                            j<span class="token punctuation">.</span>hint <span class="token operator">=</span> i<span class="token punctuation">;</span><span class="token comment">//更新stealer索引</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        checkSum <span class="token operator">+=</span> v<span class="token punctuation">.</span>base<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//2. 帮助偷取者v执行任务</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>                         <span class="token comment">// help v or descend</span>
                    <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">;</span>            <span class="token comment">//偷取者内部的任务</span>
                    <span class="token keyword">int</span> b<span class="token punctuation">;</span>
                    checkSum <span class="token operator">+=</span> <span class="token punctuation">(</span>b <span class="token operator">=</span> v<span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> next <span class="token operator">=</span> v<span class="token punctuation">.</span>currentJoin<span class="token punctuation">;</span><span class="token comment">//获取偷取者的join任务</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>subtask<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> j<span class="token punctuation">.</span>currentJoin <span class="token operator">!=</span> subtask <span class="token operator">||</span>
                            v<span class="token punctuation">.</span>currentSteal <span class="token operator">!=</span> subtask<span class="token punctuation">)</span> <span class="token comment">// stale</span>
                        <span class="token keyword">break</span> descent<span class="token punctuation">;</span> <span class="token comment">// stale，跳出descent循环重来</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">-</span> v<span class="token punctuation">.</span>top <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>a <span class="token operator">=</span> v<span class="token punctuation">.</span>array<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>subtask <span class="token operator">=</span> next<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>   <span class="token comment">//偷取者的join任务为null，跳出descent循环</span>
                            <span class="token keyword">break</span> descent<span class="token punctuation">;</span>
                        j <span class="token operator">=</span> v<span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//偷取者内部任务为空，可能任务也被偷走了；跳出本次循环，查找偷取者的偷取者</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> b<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">ASHIFT</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">ABASE</span><span class="token punctuation">;</span><span class="token comment">//获取base偏移地址</span>
                    <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
                            <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">getObjectVolatile</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取偷取者的base任务</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>v<span class="token punctuation">.</span>base <span class="token operator">==</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>             <span class="token comment">// stale</span>
                            <span class="token keyword">break</span> descent<span class="token punctuation">;</span> <span class="token comment">// stale，跳出descent循环重来</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> i<span class="token punctuation">,</span> t<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//弹出任务</span>
                            v<span class="token punctuation">.</span>base <span class="token operator">=</span> b <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>         <span class="token comment">//更新偷取者的base位</span>
                            <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> ps <span class="token operator">=</span> w<span class="token punctuation">.</span>currentSteal<span class="token punctuation">;</span><span class="token comment">//获取调用者偷来的任务</span>
                            <span class="token keyword">int</span> top <span class="token operator">=</span> w<span class="token punctuation">.</span>top<span class="token punctuation">;</span>
                            <span class="token comment">//首先更新给定workQueue的currentSteal为偷取者的base任务，然后执行该任务</span>
                            <span class="token comment">//然后通过检查top来判断给定workQueue是否有自己的任务，如果有，</span>
                            <span class="token comment">// 则依次弹出任务(LIFO)-&gt;更新currentSteal-&gt;执行该任务(注意这里是自己偷自己的任务执行)</span>
                            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                                <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putOrderedObject</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token constant">QCURRENTSTEAL</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                t<span class="token punctuation">.</span><span class="token function">doExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// clear local tasks too</span>
                            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                                    w<span class="token punctuation">.</span>top <span class="token operator">!=</span> top <span class="token operator">&amp;&amp;</span> <span class="token comment">//内部有自己的任务，依次弹出执行</span>
                                    <span class="token punctuation">(</span>t <span class="token operator">=</span> w<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putOrderedObject</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token constant">QCURRENTSTEAL</span><span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//还原给定workQueue的currentSteal</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>w<span class="token punctuation">.</span>base <span class="token operator">!=</span> w<span class="token punctuation">.</span>top<span class="token punctuation">)</span><span class="token comment">//给定workQueue有自己的任务了，帮助结束，返回</span>
                                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token comment">// can't further help</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> oldSum <span class="token operator">!=</span> <span class="token punctuation">(</span>oldSum <span class="token operator">=</span> checkSum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>说明: 如果队列为空或任务执行失败，说明任务可能被偷，调用此方法来帮助偷取者执行任务。基本思想是: 偷取者帮助我执行任务，我去帮助偷取者执行它的任务。 函数执行流程如下:</p> <p>循环定位偷取者，由于Worker是在奇数索引位，所以每次会跳两个索引位。定位到偷取者之后，更新调用者 WorkQueue 的hint为偷取者的索引，方便下次定位； 定位到偷取者后，开始帮助偷取者执行任务。从偷取者的base索引开始，每次偷取一个任务执行。在帮助偷取者执行任务后，如果调用者发现本身已经有任务(w.top != top)，则依次弹出自己的任务(LIFO顺序)并执行(也就是说自己偷自己的任务执行)。</p> <h4 id="forkjoinpool-trycompensate-workqueue-w"><a href="#forkjoinpool-trycompensate-workqueue-w" class="header-anchor">#</a> ForkJoinPool.tryCompensate(WorkQueue w)</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//执行补偿操作: 尝试缩减活动线程量，可能释放或创建一个补偿线程来准备阻塞</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">tryCompensate</span><span class="token punctuation">(</span><span class="token class-name">WorkQueue</span> w<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> canBlock<span class="token punctuation">;</span>
    <span class="token class-name">WorkQueue</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ws<span class="token punctuation">;</span>
    <span class="token keyword">long</span> c<span class="token punctuation">;</span>
    <span class="token keyword">int</span> m<span class="token punctuation">,</span> pc<span class="token punctuation">,</span> sp<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> w<span class="token punctuation">.</span>qlock <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>           <span class="token comment">// caller terminating</span>
            <span class="token punctuation">(</span>ws <span class="token operator">=</span> workQueues<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>m <span class="token operator">=</span> ws<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span>
            <span class="token punctuation">(</span>pc <span class="token operator">=</span> config <span class="token operator">&amp;</span> <span class="token constant">SMASK</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>           <span class="token comment">// parallelism disabled</span>
        canBlock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">//调用者已终止</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>c <span class="token operator">=</span> ctl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>      <span class="token comment">// release idle worker</span>
        canBlock <span class="token operator">=</span> <span class="token function">tryRelease</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> ws<span class="token punctuation">[</span>sp <span class="token operator">&amp;</span> m<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//唤醒等待的工作线程</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">//没有空闲线程</span>
        <span class="token keyword">int</span> ac <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>c <span class="token operator">&gt;&gt;</span> <span class="token constant">AC_SHIFT</span><span class="token punctuation">)</span> <span class="token operator">+</span> pc<span class="token punctuation">;</span> <span class="token comment">//活跃线程数</span>
        <span class="token keyword">int</span> tc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>c <span class="token operator">&gt;&gt;</span> <span class="token constant">TC_SHIFT</span><span class="token punctuation">)</span> <span class="token operator">+</span> pc<span class="token punctuation">;</span><span class="token comment">//总线程数</span>
        <span class="token keyword">int</span> nbusy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                        <span class="token comment">// validate saturation</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> m<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// two passes of odd indices</span>
            <span class="token class-name">WorkQueue</span> v<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>v <span class="token operator">=</span> ws<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> m<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//取奇数索引位</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>scanState <span class="token operator">&amp;</span> <span class="token constant">SCANNING</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//没有正在运行任务，跳出</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token operator">++</span>nbusy<span class="token punctuation">;</span><span class="token comment">//正在运行任务，添加标记</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nbusy <span class="token operator">!=</span> <span class="token punctuation">(</span>tc <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">||</span> ctl <span class="token operator">!=</span> c<span class="token punctuation">)</span>
            canBlock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                 <span class="token comment">// unstable or stale</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tc <span class="token operator">&gt;=</span> pc <span class="token operator">&amp;&amp;</span> ac <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> w<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//总线程数大于并行度 &amp;&amp; 活动线程数大于1 &amp;&amp; 调用者任务队列为空，不需要补偿</span>
            <span class="token keyword">long</span> nc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token constant">AC_MASK</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>c <span class="token operator">-</span> <span class="token constant">AC_UNIT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span>
                    <span class="token punctuation">(</span><span class="token operator">~</span><span class="token constant">AC_MASK</span> <span class="token operator">&amp;</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// uncompensated</span>
            canBlock <span class="token operator">=</span> <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">CTL</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> nc<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新活跃线程数</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tc <span class="token operator">&gt;=</span> <span class="token constant">MAX_CAP</span> <span class="token operator">||</span>
                <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> common <span class="token operator">&amp;&amp;</span> tc <span class="token operator">&gt;=</span> pc <span class="token operator">+</span> commonMaxSpares<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//超出最大线程数</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RejectedExecutionException</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;Thread limit exceeded replacing blocked worker&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>                                <span class="token comment">// similar to tryAddWorker</span>
            <span class="token keyword">boolean</span> add <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> rs<span class="token punctuation">;</span>      <span class="token comment">// CAS within lock</span>
            <span class="token keyword">long</span> nc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token constant">AC_MASK</span> <span class="token operator">&amp;</span> c<span class="token punctuation">)</span> <span class="token operator">|</span>
                    <span class="token punctuation">(</span><span class="token constant">TC_MASK</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>c <span class="token operator">+</span> <span class="token constant">TC_UNIT</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//计算总线程数</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>rs <span class="token operator">=</span> <span class="token function">lockRunState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token constant">STOP</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                add <span class="token operator">=</span> <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">CTL</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> nc<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新总线程数</span>
            <span class="token function">unlockRunState</span><span class="token punctuation">(</span>rs<span class="token punctuation">,</span> rs <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token constant">RSLOCK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//运行到这里说明活跃工作线程数不足，需要创建一个新的工作线程来补偿</span>
            canBlock <span class="token operator">=</span> add <span class="token operator">&amp;&amp;</span> <span class="token function">createWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// throws on exception</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> canBlock<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>说明: 具体的执行看源码及注释，这里我们简单总结一下需要和不需要补偿的几种情况:</p> <p><strong>需要补偿</strong> :</p> <ul><li>调用者队列不为空，并且有空闲工作线程，这种情况会唤醒空闲线程(调用tryRelease方法)</li> <li>池尚未停止，活跃线程数不足，这时会新建一个工作线程(调用createWorker方法)</li></ul> <p><strong>不需要补偿</strong> :</p> <ul><li>调用者已终止或池处于不稳定状态</li> <li>总线程数大于并行度 &amp;&amp; 活动线程数大于1 &amp;&amp; 调用者任务队列为空</li></ul> <h2 id="fork-join的陷阱与注意事项"><a href="#fork-join的陷阱与注意事项" class="header-anchor">#</a> Fork/Join的陷阱与注意事项</h2> <p>使用Fork/Join框架时，需要注意一些陷阱, 在下面 <code>斐波那契数列</code>例子中你将看到示例:</p> <h3 id="避免不必要的fork"><a href="#避免不必要的fork" class="header-anchor">#</a> 避免不必要的fork()</h3> <p>划分成两个子任务后，不要同时调用两个子任务的fork()方法。</p> <p>表面上看上去两个子任务都fork()，然后join()两次似乎更自然。但事实证明，直接调用compute()效率更高。因为直接调用子任务的compute()方法实际上就是在当前的工作线程进行了计算(线程重用)，这比“将子任务提交到工作队列，线程又从工作队列中拿任务”快得多。</p> <blockquote><p>当一个大任务被划分成两个以上的子任务时，尽可能使用前面说到的三个衍生的invokeAll方法，因为使用它们能避免不必要的fork()。</p></blockquote> <h3 id="注意fork-、compute-、join-的顺序"><a href="#注意fork-、compute-、join-的顺序" class="header-anchor">#</a> 注意fork()、compute()、join()的顺序</h3> <p>为了两个任务并行，三个方法的调用顺序需要万分注意。</p> <div class="language-java extra-class"><pre class="language-java"><code>right<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 计算右边的任务</span>
<span class="token keyword">long</span> leftAns <span class="token operator">=</span> left<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 计算左边的任务(同时右边任务也在计算)</span>
<span class="token keyword">long</span> rightAns <span class="token operator">=</span> right<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待右边的结果</span>
<span class="token keyword">return</span> leftAns <span class="token operator">+</span> rightAns<span class="token punctuation">;</span>
</code></pre></div><p>如果我们写成:</p> <div class="language-java extra-class"><pre class="language-java"><code>left<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 计算完左边的任务</span>
<span class="token keyword">long</span> leftAns <span class="token operator">=</span> left<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待左边的计算结果</span>
<span class="token keyword">long</span> rightAns <span class="token operator">=</span> right<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 再计算右边的任务</span>
<span class="token keyword">return</span> leftAns <span class="token operator">+</span> rightAns<span class="token punctuation">;</span>
</code></pre></div><p>或者</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">long</span> rightAns <span class="token operator">=</span> right<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 计算完右边的任务</span>
left<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 再计算左边的任务</span>
<span class="token keyword">long</span> leftAns <span class="token operator">=</span> left<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待左边的计算结果</span>
<span class="token keyword">return</span> leftAns <span class="token operator">+</span> rightAns<span class="token punctuation">;</span>
</code></pre></div><p>这两种实际上都没有并行。</p> <h3 id="选择合适的子任务粒度"><a href="#选择合适的子任务粒度" class="header-anchor">#</a> 选择合适的子任务粒度</h3> <p>选择划分子任务的粒度(顺序执行的阈值)很重要，因为使用Fork/Join框架并不一定比顺序执行任务的效率高: 如果任务太大，则无法提高并行的吞吐量；如果任务太小，子任务的调度开销可能会大于并行计算的性能提升，我们还要考虑创建子任务、fork()子任务、线程调度以及合并子任务处理结果的耗时以及相应的内存消耗。</p> <p>官方文档给出的粗略经验是: 任务应该执行<code>100~10000</code>个基本的计算步骤。决定子任务的粒度的最好办法是实践，通过实际测试结果来确定这个阈值才是“上上策”。</p> <blockquote><p>和其他Java代码一样，Fork/Join框架测试时需要“预热”或者说执行几遍才会被JIT(Just-in-time)编译器优化，所以测试性能之前跑几遍程序很重要。</p></blockquote> <h3 id="避免重量级任务划分与结果合并"><a href="#避免重量级任务划分与结果合并" class="header-anchor">#</a> 避免重量级任务划分与结果合并</h3> <p>Fork/Join的很多使用场景都用到数组或者List等数据结构，子任务在某个分区中运行，最典型的例子如并行排序和并行查找。拆分子任务以及合并处理结果的时候，应该尽量避免System.arraycopy这样耗时耗空间的操作，从而最小化任务的处理开销。</p> <h2 id="再深入理解"><a href="#再深入理解" class="header-anchor">#</a> 再深入理解</h2> <h3 id="有哪些jdk源码中使用了fork-join思想"><a href="#有哪些jdk源码中使用了fork-join思想" class="header-anchor">#</a> 有哪些JDK源码中使用了Fork/Join思想?</h3> <p>我们常用的数组工具类 Arrays 在JDK 8之后新增的并行排序方法(parallelSort)就运用了 ForkJoinPool 的特性，还有 ConcurrentHashMap 在JDK 8之后添加的函数式方法(如forEach等)也有运用。</p> <h3 id="使用executors工具类创建forkjoinpool"><a href="#使用executors工具类创建forkjoinpool" class="header-anchor">#</a> 使用Executors工具类创建ForkJoinPool</h3> <p>Java8在Executors工具类中新增了两个工厂方法:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// parallelism定义并行级别</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newWorkStealingPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> parallelism<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 默认并行级别为JVM可用的处理器个数</span>
<span class="token comment">// Runtime.getRuntime().availableProcessors()</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newWorkStealingPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="关于fork-join异常处理"><a href="#关于fork-join异常处理" class="header-anchor">#</a> 关于Fork/Join异常处理</h3> <p>Java的受检异常机制一直饱受诟病，所以在ForkJoinTask的invoke()、join()方法及其衍生方法中都没有像get()方法那样抛出个ExecutionException的受检异常。</p> <p>所以你可以在ForkJoinTask中看到内部把受检异常转换成了运行时异常。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">rethrow</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token class-name">ForkJoinTask</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RuntimeException</span><span class="token punctuation">&gt;</span></span><span class="token function">uncheckedThrow</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Throwable</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">uncheckedThrow</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">T</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span>t<span class="token punctuation">;</span> <span class="token comment">// rely on vacuous cast</span>
<span class="token punctuation">}</span>
</code></pre></div><p>关于Java你不知道的10件事中已经指出，JVM实际并不关心这个异常是受检异常还是运行时异常，受检异常这东西完全是给Java编译器用的: 用于警告程序员这里有个异常没有处理。</p> <p>但不可否认的是invoke、join()仍可能会抛出运行时异常，所以ForkJoinTask还提供了两个不提取结果和异常的方法quietlyInvoke()、quietlyJoin()，这两个方法允许你在所有任务完成后对结果和异常进行处理。</p> <p>使用quitelyInvoke()和quietlyJoin()时可以配合isCompletedAbnormally()和isCompletedNormally()方法使用。</p> <h2 id="一些fork-join例子"><a href="#一些fork-join例子" class="header-anchor">#</a> 一些Fork/Join例子</h2> <h3 id="采用fork-join来异步计算1-2-3-10000的结果"><a href="#采用fork-join来异步计算1-2-3-10000的结果" class="header-anchor">#</a> 采用Fork/Join来异步计算1+2+3+…+10000的结果</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
	<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">SumTask</span> <span class="token keyword">extends</span> <span class="token class-name">RecursiveTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
		<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
		
		<span class="token keyword">final</span> <span class="token keyword">int</span> start<span class="token punctuation">;</span> <span class="token comment">//开始计算的数</span>
		<span class="token keyword">final</span> <span class="token keyword">int</span> end<span class="token punctuation">;</span> <span class="token comment">//最后计算的数</span>
		
		<span class="token class-name">SumTask</span><span class="token punctuation">(</span><span class="token keyword">int</span> start<span class="token punctuation">,</span> <span class="token keyword">int</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">=</span> start<span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>end <span class="token operator">=</span> end<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">protected</span> <span class="token class-name">Integer</span> <span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">//如果计算量小于1000，那么分配一个线程执行if中的代码块，并返回执行结果</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>end <span class="token operator">-</span> start <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; 开始执行: &quot;</span> <span class="token operator">+</span> start <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
				<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> start<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> end<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
					sum <span class="token operator">+=</span> i<span class="token punctuation">;</span>
				<span class="token keyword">return</span> sum<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">//如果计算量大于1000，那么拆分为两个任务</span>
			<span class="token class-name">SumTask</span> task1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SumTask</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> <span class="token punctuation">(</span>start <span class="token operator">+</span> end<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">SumTask</span> task2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SumTask</span><span class="token punctuation">(</span><span class="token punctuation">(</span>start <span class="token operator">+</span> end<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//执行任务</span>
			task1<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			task2<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//获取任务执行的结果</span>
			<span class="token keyword">return</span> task1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> task2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{</span>
		<span class="token class-name">ForkJoinPool</span> pool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SumTask</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		pool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>执行结果</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ForkJoinPool</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span> 开始执行<span class="token operator">:</span> <span class="token number">1</span><span class="token operator">-</span><span class="token number">625</span>
<span class="token class-name">ForkJoinPool</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">7</span> 开始执行<span class="token operator">:</span> <span class="token number">6251</span><span class="token operator">-</span><span class="token number">6875</span>
<span class="token class-name">ForkJoinPool</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">6</span> 开始执行<span class="token operator">:</span> <span class="token number">5626</span><span class="token operator">-</span><span class="token number">6250</span>
<span class="token class-name">ForkJoinPool</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">10</span> 开始执行<span class="token operator">:</span> <span class="token number">3751</span><span class="token operator">-</span><span class="token number">4375</span>
<span class="token class-name">ForkJoinPool</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">13</span> 开始执行<span class="token operator">:</span> <span class="token number">2501</span><span class="token operator">-</span><span class="token number">3125</span>
<span class="token class-name">ForkJoinPool</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">8</span> 开始执行<span class="token operator">:</span> <span class="token number">626</span><span class="token operator">-</span><span class="token number">1250</span>
<span class="token class-name">ForkJoinPool</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">11</span> 开始执行<span class="token operator">:</span> <span class="token number">5001</span><span class="token operator">-</span><span class="token number">5625</span>
<span class="token class-name">ForkJoinPool</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">3</span> 开始执行<span class="token operator">:</span> <span class="token number">7501</span><span class="token operator">-</span><span class="token number">8125</span>
<span class="token class-name">ForkJoinPool</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">14</span> 开始执行<span class="token operator">:</span> <span class="token number">1251</span><span class="token operator">-</span><span class="token number">1875</span>
<span class="token class-name">ForkJoinPool</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">4</span> 开始执行<span class="token operator">:</span> <span class="token number">9376</span><span class="token operator">-</span><span class="token number">10000</span>
<span class="token class-name">ForkJoinPool</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">8</span> 开始执行<span class="token operator">:</span> <span class="token number">8126</span><span class="token operator">-</span><span class="token number">8750</span>
<span class="token class-name">ForkJoinPool</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">0</span> 开始执行<span class="token operator">:</span> <span class="token number">1876</span><span class="token operator">-</span><span class="token number">2500</span>
<span class="token class-name">ForkJoinPool</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">12</span> 开始执行<span class="token operator">:</span> <span class="token number">4376</span><span class="token operator">-</span><span class="token number">5000</span>
<span class="token class-name">ForkJoinPool</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">5</span> 开始执行<span class="token operator">:</span> <span class="token number">8751</span><span class="token operator">-</span><span class="token number">9375</span>
<span class="token class-name">ForkJoinPool</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">7</span> 开始执行<span class="token operator">:</span> <span class="token number">6876</span><span class="token operator">-</span><span class="token number">7500</span>
<span class="token class-name">ForkJoinPool</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span> 开始执行<span class="token operator">:</span> <span class="token number">3126</span><span class="token operator">-</span><span class="token number">3750</span>
<span class="token number">50005000</span>
</code></pre></div><h3 id="实现斐波那契数列"><a href="#实现斐波那契数列" class="header-anchor">#</a> 实现斐波那契数列</h3> <blockquote><p>斐波那契数列: 1、1、2、3、5、8、13、21、34、…… 公式 : F(1)=1，F(2)=1, F(n)=F(n-1)+F(n-2)(n&gt;=3，n∈N*)</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ForkJoinPool</span> forkJoinPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 最大并发数4</span>
    <span class="token class-name">Fibonacci</span> fibonacci <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Fibonacci</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Integer</span> result <span class="token operator">=</span> forkJoinPool<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>fibonacci<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> endTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Fork/join sum: &quot;</span> <span class="token operator">+</span> result <span class="token operator">+</span> <span class="token string">&quot; in &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>endTime <span class="token operator">-</span> startTime<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; ms.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//以下为官方API文档示例</span>
<span class="token keyword">static</span>  <span class="token keyword">class</span> <span class="token class-name">Fibonacci</span> <span class="token keyword">extends</span> <span class="token class-name">RecursiveTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> n<span class="token punctuation">;</span>
    <span class="token class-name">Fibonacci</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>n <span class="token operator">=</span> n<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Integer</span> <span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> n<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Fibonacci</span> f1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Fibonacci</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        f1<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token class-name">Fibonacci</span> f2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Fibonacci</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> f2<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> f1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当然你也可以两个任务都fork，要注意的是两个任务都fork的情况，必须按照f1.fork()，f2.fork()， f2.join()，f1.join()这样的顺序，不然有性能问题，详见上面注意事项中的说明。</p> <p>官方API文档是这样写到的，所以平日用invokeAll就好了。invokeAll会把传入的任务的第一个交给当前线程来执行，其他的任务都fork加入工作队列，这样等于利用当前线程也执行任务了。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token class-name">Fibonacci</span> f1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Fibonacci</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Fibonacci</span> f2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Fibonacci</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">invokeAll</span><span class="token punctuation">(</span>f1<span class="token punctuation">,</span>f2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> f2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> f1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">invokeAll</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> tasks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Throwable</span> ex <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> last <span class="token operator">=</span> tasks<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> last<span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> t <span class="token operator">=</span> tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                ex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>   <span class="token comment">//除了第一个都fork</span>
            t<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">doInvoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token constant">NORMAL</span> <span class="token operator">&amp;&amp;</span> ex <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>  <span class="token comment">//留一个自己执行</span>
            ex <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">getException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> last<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> t <span class="token operator">=</span> tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                t<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">doJoin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token constant">NORMAL</span><span class="token punctuation">)</span>
                ex <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">getException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token function">rethrow</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="参考文章"><a href="#参考文章" class="header-anchor">#</a> 参考文章</h2> <ul><li>首先推荐阅读ForkJoinPool的作者Doug Lea的一篇文章《A Java Fork/Join Framework》<a href="http://gee.cs.oswego.edu/dl/papers/fj.pdf" target="_blank" rel="noopener noreferrer">英文原文地址在新窗口打开<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>本文主要参考自泰迪的bagwell的https://www.jianshu.com/p/32a15ef2f1bf和https://www.jianshu.com/p/6a14d0b54b8d，在此基础上参考了如下文章</li> <li>https://blog.csdn.net/u010841296/article/details/83963637</li> <li>https://blog.csdn.net/Holmofy/article/details/82714665</li> <li>https://blog.csdn.net/abc123lzf/article/details/82873181</li> <li>https://blog.csdn.net/yinwenjie/article/details/71524140</li> <li>https://blog.csdn.net/cowbin2012/article/details/89791757</li> <li>转载 https://www.pdai.tech/md/java/thread/java-thread-x-juc-executor-ForkJoinPool.html</li></ul></div></section> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/lowskylee/vblog/edit/master/docs/java/thread/java-thread-x-juc-executor-ForkJoinPool.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2023/4/9 16:04:35</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/vblog/java/thread/java-thread-x-juc-executor-ScheduledThreadPoolExecutor.html" class="prev">
          JUC线程池: ScheduledThreadPoolExecutor详解
        </a></span> <span class="next"><a href="/vblog/java/thread/java-thread-x-juc-tool-countdownlatch.html">
          JUC工具类: CountDownLatch详解
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-6ea58682 data-v-58d791b2><li class="level-2" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#juc线程池-fork-join框架详解" class="sidebar-link reco-side-juc线程池-fork-join框架详解" data-v-6ea58682>JUC线程池: Fork/Join框架详解</a></li><li class="level-2" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#带着bat大厂的面试问题去理解fork-join框架" class="sidebar-link reco-side-带着bat大厂的面试问题去理解fork-join框架" data-v-6ea58682>带着BAT大厂的面试问题去理解Fork/Join框架</a></li><li class="level-2" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#fork-join框架简介" class="sidebar-link reco-side-fork-join框架简介" data-v-6ea58682>Fork/Join框架简介</a></li><li class="level-3" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#三个模块及关系" class="sidebar-link reco-side-三个模块及关系" data-v-6ea58682>三个模块及关系</a></li><li class="level-3" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#核心思想-分治算法-divide-and-conquer" class="sidebar-link reco-side-核心思想-分治算法-divide-and-conquer" data-v-6ea58682>核心思想: 分治算法(Divide-and-Conquer)</a></li><li class="level-3" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#核心思想-work-stealing-工作窃取-算法" class="sidebar-link reco-side-核心思想-work-stealing-工作窃取-算法" data-v-6ea58682>核心思想: work-stealing(工作窃取)算法</a></li><li class="level-3" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#fork-join-框架的执行流程" class="sidebar-link reco-side-fork-join-框架的执行流程" data-v-6ea58682>Fork/Join 框架的执行流程</a></li><li class="level-2" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#fork-join类关系" class="sidebar-link reco-side-fork-join类关系" data-v-6ea58682>Fork/Join类关系</a></li><li class="level-3" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#forkjoinpool继承关系" class="sidebar-link reco-side-forkjoinpool继承关系" data-v-6ea58682>ForkJoinPool继承关系</a></li><li class="level-3" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#forkjointask继承关系" class="sidebar-link reco-side-forkjointask继承关系" data-v-6ea58682>ForkJoinTask继承关系</a></li><li class="level-2" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#fork-join框架源码解析" class="sidebar-link reco-side-fork-join框架源码解析" data-v-6ea58682>Fork/Join框架源码解析</a></li><li class="level-3" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#forkjoinpool" class="sidebar-link reco-side-forkjoinpool" data-v-6ea58682>ForkJoinPool</a></li><li class="level-3" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#forkjointask" class="sidebar-link reco-side-forkjointask" data-v-6ea58682>ForkJoinTask</a></li><li class="level-2" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#fork-join框架源码解析-2" class="sidebar-link reco-side-fork-join框架源码解析-2" data-v-6ea58682>Fork/Join框架源码解析</a></li><li class="level-3" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#构造函数" class="sidebar-link reco-side-构造函数" data-v-6ea58682>构造函数</a></li><li class="level-3" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#执行流程-外部任务-external-submissions-task-提交" class="sidebar-link reco-side-执行流程-外部任务-external-submissions-task-提交" data-v-6ea58682>执行流程 - 外部任务(external/submissions task)提交</a></li><li class="level-3" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#执行流程-子任务-worker-task-提交" class="sidebar-link reco-side-执行流程-子任务-worker-task-提交" data-v-6ea58682>执行流程: 子任务(Worker task)提交</a></li><li class="level-3" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#执行流程-任务执行" class="sidebar-link reco-side-执行流程-任务执行" data-v-6ea58682>执行流程: 任务执行</a></li><li class="level-3" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#获取任务结果-forkjointask-join-forkjointask-invoke" class="sidebar-link reco-side-获取任务结果-forkjointask-join-forkjointask-invoke" data-v-6ea58682>获取任务结果 - ForkJoinTask.join() / ForkJoinTask.invoke()</a></li><li class="level-2" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#fork-join的陷阱与注意事项" class="sidebar-link reco-side-fork-join的陷阱与注意事项" data-v-6ea58682>Fork/Join的陷阱与注意事项</a></li><li class="level-3" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#避免不必要的fork" class="sidebar-link reco-side-避免不必要的fork" data-v-6ea58682>避免不必要的fork()</a></li><li class="level-3" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#注意fork-、compute-、join-的顺序" class="sidebar-link reco-side-注意fork-、compute-、join-的顺序" data-v-6ea58682>注意fork()、compute()、join()的顺序</a></li><li class="level-3" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#选择合适的子任务粒度" class="sidebar-link reco-side-选择合适的子任务粒度" data-v-6ea58682>选择合适的子任务粒度</a></li><li class="level-3" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#避免重量级任务划分与结果合并" class="sidebar-link reco-side-避免重量级任务划分与结果合并" data-v-6ea58682>避免重量级任务划分与结果合并</a></li><li class="level-2" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#再深入理解" class="sidebar-link reco-side-再深入理解" data-v-6ea58682>再深入理解</a></li><li class="level-3" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#有哪些jdk源码中使用了fork-join思想" class="sidebar-link reco-side-有哪些jdk源码中使用了fork-join思想" data-v-6ea58682>有哪些JDK源码中使用了Fork/Join思想?</a></li><li class="level-3" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#使用executors工具类创建forkjoinpool" class="sidebar-link reco-side-使用executors工具类创建forkjoinpool" data-v-6ea58682>使用Executors工具类创建ForkJoinPool</a></li><li class="level-3" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#关于fork-join异常处理" class="sidebar-link reco-side-关于fork-join异常处理" data-v-6ea58682>关于Fork/Join异常处理</a></li><li class="level-2" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#一些fork-join例子" class="sidebar-link reco-side-一些fork-join例子" data-v-6ea58682>一些Fork/Join例子</a></li><li class="level-3" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#采用fork-join来异步计算1-2-3-10000的结果" class="sidebar-link reco-side-采用fork-join来异步计算1-2-3-10000的结果" data-v-6ea58682>采用Fork/Join来异步计算1+2+3+…+10000的结果</a></li><li class="level-3" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#实现斐波那契数列" class="sidebar-link reco-side-实现斐波那契数列" data-v-6ea58682>实现斐波那契数列</a></li><li class="level-2" data-v-6ea58682><a href="/vblog/java/thread/java-thread-x-juc-executor-ForkJoinPool.html#参考文章" class="sidebar-link reco-side-参考文章" data-v-6ea58682>参考文章</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div class="kanbanniang" data-v-5775ee02><div class="banniang-container" style="display:;" data-v-5775ee02><div class="messageBox" style="right:68px;bottom:290px;display:none;" data-v-5775ee02>
      欢迎来到我的博客
    </div> <div class="operation" style="right:90px;bottom:40px;display:none;" data-v-5775ee02><i class="kbnfont kbn-ban-home ban-home" data-v-5775ee02></i> <i class="kbnfont kbn-ban-message message" data-v-5775ee02></i> <i class="kbnfont kbn-ban-close close" data-v-5775ee02></i> <a target="_blank" href="https://vuepress-theme-reco.recoluan.com/views/plugins/kanbanniang.html" data-v-5775ee02><i class="kbnfont kbn-ban-info info" data-v-5775ee02></i></a> <i class="kbnfont kbn-ban-theme skin" style="display:;" data-v-5775ee02></i></div> <canvas id="banniang" width="250" height="320" class="live2d" style="right:90px;bottom:-20px;opacity:0.9;" data-v-5775ee02></canvas></div> <div class="showBanNiang" style="display:none;" data-v-5775ee02>
    看板娘
  </div></div></div></div>
    <script src="/vblog/assets/js/app.83d9a4e3.js" defer></script><script src="/vblog/assets/js/3.777b06c3.js" defer></script><script src="/vblog/assets/js/1.0fcecb2e.js" defer></script><script src="/vblog/assets/js/61.336f0c64.js" defer></script>
  </body>
</html>
